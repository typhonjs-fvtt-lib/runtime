import{get as t,writable as e}from"@typhonjs-fvtt/runtime/svelte/store";import{noop as s,run_all as n,is_function as o}from"@typhonjs-fvtt/runtime/svelte/internal";function r(t,e){var s=function(t,e,s){if(!e.has(t))throw new TypeError("attempted to get private field on non-instance");return e.get(t)}(t,e);return function(t,e){return e.get?e.get.call(t):e.value}(t,s)}function i(t,e,s){!function(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}(t,e),e.set(t,s)}function a(r){function i(t,e,s){return{subscribe:a(t,e,s).subscribe}}function a(n,o,i=s){r&&(r.getItem(n)&&(o=JSON.parse(r.getItem(n))),r.setItem(n,JSON.stringify(o)));const a=e(o,i?function(t){return i((function(e){return r&&r.setItem(n,JSON.stringify(e)),t(e)}))}:void 0);function g(t){r&&r.setItem(n,JSON.stringify(t)),a.set(t)}return{set:g,update:function(e){g(e(t(a)))},subscribe:function(t,e=s){return a.subscribe(t,e)}}}return{readable:i,writable:a,derived:function(t,e,a,g){const u=!Array.isArray(e),c=u?[e]:e;return r&&r.getItem(t)&&(g=JSON.parse(r.getItem(t))),i(t,g,(t=>{let e=!1;const r=[];let i=0,g=s;const l=()=>{if(i)return;g();const e=u?r[0]:r;if(a.length<2)t(a(e));else{const n=a(e,t);g=o(n)?n:s}},p=c.map(((t,s)=>t.subscribe((t=>{r[s]=t,i&=~(1<<s),e&&l()}),(()=>{i|=1<<s}))));return e=!0,l(),function(){n(p),g()}}))},get:t}}var g=a("undefined"!=typeof window?window.localStorage:void 0).writable,u=new WeakMap;class c{constructor(){i(this,u,{writable:!0,value:new Map})}getItem(t,e){let s;const n=localStorage.getItem(t);return void 0!==n&&(s=JSON.parse(n)),s}getStore(t,e){return l(r(this,u),t,e)}setItem(t,e){l(r(this,u),t).set(e)}swapItemBoolean(t,e){const s=l(r(this,u),t,e),n=s.get(),o="boolean"==typeof n&&!n;return s.set(o),o}}function l(e,s,n){let o=e.get(s);return void 0===o&&(o=function(e,s){try{localStorage.getItem(e)&&(s=JSON.parse(localStorage.getItem(e)))}catch(t){}const n=g(e,s);return n.get=()=>t(n),n}(s,n),e.set(s,o)),o}var p=a("undefined"!=typeof window?window.sessionStorage:void 0).writable,m=new WeakMap;class f{constructor(){i(this,m,{writable:!0,value:new Map})}getItem(t){let e;const s=sessionStorage.getItem(t);return void 0!==s&&(e=JSON.parse(s)),e}getStore(t,e){return d(r(this,m),t,e)}setItem(t,e){d(r(this,m),t).set(e)}swapItemBoolean(t,e){const s=d(r(this,m),t,e),n=s.get(),o="boolean"==typeof n&&!n;return s.set(o),o}}function d(e,s,n){let o=e.get(s);return void 0===o&&(o=function(e,s){try{sessionStorage.getItem(e)&&(s=JSON.parse(sessionStorage.getItem(e)))}catch(t){}const n=p(e,s);return n.get=()=>t(n),n}(s,n),e.set(s,o)),o}class h{#t=new c;onPluginLoad(t){const e="string"==typeof t?.pluginOptions?.eventPrepend?`${t.pluginOptions.eventPrepend}:`:"";t.eventbus.on(`${e}storage:local:item:get`,this.#t.getItem,this.#t,{guard:!0}),t.eventbus.on(`${e}storage:local:item:boolean:swap`,this.#t.swapItemBoolean,this.#t,{guard:!0}),t.eventbus.on(`${e}storage:local:item:set`,this.#t.setItem,this.#t,{guard:!0}),t.eventbus.on(`${e}storage:local:store:get`,this.#t.getStore,this.#t,{guard:!0})}}class v{#t=new f;onPluginLoad(t){const e="string"==typeof t?.pluginOptions?.eventPrepend?`${t.pluginOptions.eventPrepend}:`:"";t.eventbus.on(`${e}storage:session:item:get`,this.#t.getItem,this.#t,{guard:!0}),t.eventbus.on(`${e}storage:session:item:boolean:swap`,this.#t.swapItemBoolean,this.#t,{guard:!0}),t.eventbus.on(`${e}storage:session:item:set`,this.#t.setItem,this.#t,{guard:!0}),t.eventbus.on(`${e}storage:session:store:get`,this.#t.getStore,this.#t,{guard:!0})}}export{h as LocalStorage,v as SessionStorage};

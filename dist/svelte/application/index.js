import{writable as t,derived as e}from"@typhonjs-fvtt/runtime/svelte/store";import{outroAndDestroy as n,isApplicationShell as i,hasGetter as s,parseSvelteConfig as o}from"@typhonjs-fvtt/runtime/svelte/util";import{DialogShell as r,TJSContextMenu as l}from"@typhonjs-fvtt/runtime/svelte/component/core";function a(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function c(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?a(Object(n),!0).forEach((function(e){h(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function h(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function u(t,e){return g(t,f(t,e,"get"))}function p(t,e,n){return b(t,f(t,e,"set"),n),n}function f(t,e,n){if(!e.has(t))throw new TypeError("attempted to "+n+" private field on non-instance");return e.get(t)}function d(t,e,n){return y(t,e),w(n,"get"),g(t,n)}function m(t,e,n,i){return y(t,e),w(n,"set"),b(t,n,i),i}function g(t,e){return e.get?e.get.call(t):e.value}function b(t,e,n){if(e.set)e.set.call(t,n);else{if(!e.writable)throw new TypeError("attempted to set read only private field");e.value=n}}function y(t,e){if(t!==e)throw new TypeError("Private static access of wrong provenance")}function w(t,e){if(void 0===t)throw new TypeError("attempted to "+e+" private static field before its declaration")}function v(t,e,n){if(!e.has(t))throw new TypeError("attempted to get private field on non-instance");return n}function O(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function T(t,e,n){O(t,e),e.set(t,n)}function j(t,e){O(t,e),e.add(t)}function E(t,e,n){if("object"!=typeof t)return n;if("string"!=typeof e)return n;const i=e.split(".");for(let e=0;e<i.length;e++){if(void 0===t[i[e]]||null===t[i[e]])return n;t=t[i[e]]}return t}function z(t,e,n,i="set",s=!0){if("object"!=typeof t)throw new TypeError("safeSet Error: 'data' is not an 'object'.");if("string"!=typeof e)throw new TypeError("safeSet Error: 'accessor' is not a 'string'.");const o=e.split(".");for(let e=0;e<o.length;e++){if(Array.isArray(t)){const t=+o[e];if(!Number.isInteger(t)||t<0)return!1}if(e===o.length-1)switch(i){case"add":t[o[e]]+=n;break;case"div":t[o[e]]/=n;break;case"mult":t[o[e]]*=n;break;case"set":t[o[e]]=n;break;case"set-undefined":void 0===t[o[e]]&&(t[o[e]]=n);break;case"sub":t[o[e]]-=n}else{if(s&&void 0===t[o[e]]&&(t[o[e]]={}),null===t[o[e]]||"object"!=typeof t[o[e]])return!1;t=t[o[e]]}}return!0}var M=new WeakMap,_=new WeakMap;class x{constructor(t,e){T(this,M,{writable:!0,value:void 0}),T(this,_,{writable:!0,value:void 0}),p(this,M,t),p(this,_,e)}get applicationShell(){return u(this,M)[0]}component(t){const e=u(this,_)[t];return"object"==typeof e?null==e?void 0:e.component:void 0}*componentEntries(){for(let t=0;t<u(this,_).length;t++)yield[t,u(this,_)[t].component]}*componentValues(){for(let t=0;t<u(this,_).length;t++)yield u(this,_)[t].component}data(t){return u(this,_)[t]}dataEntries(){return u(this,_).entries()}dataValues(){return u(this,_).values()}get length(){return u(this,_).length}}Object.freeze(x);var I=new WeakMap,H=new WeakMap,k=new WeakMap,S=new WeakMap,D=new WeakMap,L=new WeakMap,W=new WeakMap,A=new WeakMap,N=new WeakMap,C=new WeakMap,P=new WeakMap,F=new WeakSet,B=new WeakSet,R=new WeakSet;class G extends Application{constructor(t){super(t),j(this,R),j(this,B),j(this,F),T(this,H,{get:J,set:void 0}),T(this,I,{writable:!0,value:[null]}),T(this,k,{writable:!0,value:null}),T(this,S,{writable:!0,value:null}),T(this,D,{writable:!0,value:void 0}),T(this,L,{writable:!0,value:void 0}),T(this,W,{writable:!0,value:void 0}),T(this,A,{writable:!0,value:void 0}),T(this,N,{writable:!0,value:[]}),T(this,C,{writable:!0,value:[]}),T(this,P,{writable:!0,value:new x(u(this,I),u(this,C))}),v(this,F,q).call(this)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{draggable:!0,headerButtonNoLabel:!1,jqueryCloseAnimation:!0,zIndex:null})}get draggable(){return this.options.draggable}get elementContent(){return u(this,S)}get elementTarget(){return u(this,k)}get popOut(){return super.popOut}get resizable(){return this.options.resizable}get svelte(){return u(this,P)}get title(){return super.title}get zIndex(){return this.options.zIndex}set draggable(t){"boolean"==typeof t&&this.setOptions("draggable",t)}set elementContent(t){if(!(t instanceof HTMLElement))throw new TypeError("SvelteApplication - set elementContent error: 'content' is not an HTMLElement.");p(this,S,t)}set elementTarget(t){if(!(t instanceof HTMLElement))throw new TypeError("SvelteApplication - set elementTarget error: 'target' is not an HTMLElement.");p(this,k,t)}set popOut(t){"boolean"==typeof t&&this.setOptions("popOut",t)}set resizable(t){"boolean"==typeof t&&this.setOptions("resizable",t)}set title(t){"string"==typeof t&&this.setOptions("title",t)}set zIndex(t){this.setOptions("zIndex",Number.isInteger(t)?t:null)}async close(t={}){const e=Application.RENDER_STATES;if(!t.force&&![e.RENDERED,e.ERROR].includes(this._state))return;v(this,R,U).call(this),this._state=e.CLOSING;const i=$(u(this,k));if(!i)return this._state=e.CLOSED;for(const t of this.constructor._getInheritanceChain())Hooks.call(`close${t.name}`,this,i);("boolean"!=typeof this.options.jqueryCloseAnimation||this.options.jqueryCloseAnimation)&&(i[0].style.minHeight="0",await new Promise((t=>{i.slideUp(200,(()=>t()))})));const s=[];for(const t of u(this,C)){s.push(n(t.component));const e=t.config.eventbus;"object"==typeof e&&"function"==typeof e.off&&(e.off(),t.config.eventbus=void 0)}await Promise.all(s),u(this,C).length=0,i.remove(),u(this,I)[0]=null,this._element=null,p(this,S,null),p(this,k,null),delete ui.windows[this.appId],this._minimized=!1,this._scrollPositions=null,this._state=e.CLOSED,u(this,A).call(this,(t=>foundry.utils.mergeObject(t,{minimized:this._minimized})))}getOptions(t,e){return E(this.options,t,e)}_injectHTML(t){if(this.popOut&&0===t.length&&Array.isArray(this.options.svelte))throw new Error("SvelteApplication - _injectHTML - A popout app with no template can only support one Svelte component.");if(this.updateHeaderButtons(),Array.isArray(this.options.svelte))for(const e of this.options.svelte){const n=V(this,t,e,u(this,D),u(this,W));if(i(n.component)){if(null!==u(this,H))throw new Error(`SvelteApplication - _injectHTML - An application shell is already mounted; offending config: \n                    ${JSON.stringify(e)}`);u(this,I)[0]=n.component}u(this,C).push(n)}else if("object"==typeof this.options.svelte){const e=V(this,t,this.options.svelte,u(this,D),u(this,W));if(i(e.component)){if(null!==u(this,H))throw new Error(`SvelteApplication - _injectHTML - An application shell is already mounted; offending config: \n                 ${JSON.stringify(this.options.svelte)}`);u(this,I)[0]=e.component}u(this,C).push(e)}const e=t.length&&t[0]instanceof DocumentFragment;let n=!0;for(const t of u(this,C))if(!t.injectHTML){n=!1;break}if(n&&super._injectHTML(t),null!==u(this,H))this._element=$(u(this,H).elementRoot),p(this,S,s(u(this,H),"elementContent")?u(this,H).elementContent:null),p(this,k,s(u(this,H),"elementTarget")?u(this,H).elementTarget:null);else if(e)for(const t of u(this,C))if(t.element instanceof HTMLElement){this._element=$(t.element);break}if(null===u(this,k)){const t="string"==typeof this.options.selectorTarget?this._element.find(this.options.selectorTarget):this._element;p(this,k,t[0])}if(null===u(this,k)||void 0===u(this,k)||0===u(this,k).length)throw new Error(`SvelteApplication - _injectHTML: Target element '${this.options.selectorTarget}' not found.`);setTimeout((()=>v(this,B,Q).call(this)),0),this.onSvelteMount({element:this._element[0],elementContent:u(this,S),elementTarget:u(this,k)})}async maximize(){if(this.popOut&&![!1,null].includes(this._minimized))return u(this,A).call(this,(t=>foundry.utils.mergeObject(t,{minimized:!1}))),super.maximize()}async minimize(){if(this.rendered&&this.popOut&&![!0,null].includes(this._minimized))return u(this,A).call(this,(t=>foundry.utils.mergeObject(t,{minimized:!0}))),super.minimize()}mergeOptions(t){u(this,L).call(this,(e=>foundry.utils.mergeObject(e,t)))}onSvelteMount({element:t,elementContent:e,elementTarget:n}){}_replaceHTML(t,e){t.length&&this.updateHeaderButtons()}async _renderInner(t){const e="string"==typeof this.template?await renderTemplate(this.template,t):document.createDocumentFragment();return $(e)}setOptions(t,e){z(this.options,t,e)&&u(this,L).call(this,(()=>this.options))}setPosition({left:t,top:e,width:n,height:i,scale:s,noHeight:o=!1,noWidth:r=!1}={}){const l=this.elementTarget,a=this.position,c=globalThis.getComputedStyle(l);if(!l.style.width||n){const e=n||l.offsetWidth,i=parseInt(c.minWidth)||MIN_WINDOW_WIDTH,s=l.style.maxWidth||globalThis.innerWidth;a.width=n=Math.clamped(e,i,s),r||(l.style.width=`${n}px`),n+a.left>globalThis.innerWidth&&(t=a.left)}if(n=l.offsetWidth,!l.style.height||i){const t=i||l.offsetHeight+1,n=parseInt(c.minHeight)||MIN_WINDOW_HEIGHT,s=l.style.maxHeight||globalThis.innerHeight;a.height=i=Math.clamped(t,n,s),o||(l.style.height=`${i}px`),i+a.top>globalThis.innerHeight+1&&(e=a.top-1)}if(i=l.offsetHeight,!l.style.left||Number.isFinite(t)){const e=Number.isFinite(t)?t:(globalThis.innerWidth-n)/2,i=Math.max(globalThis.innerWidth-n,0);a.left=t=Math.clamped(e,0,i),l.style.left=`${t}px`}if(!l.style.top||Number.isFinite(e)){const t=Number.isFinite(e)?e:(globalThis.innerHeight-i)/2,n=Math.max(globalThis.innerHeight-i,0);a.top=e=Math.clamped(t,0,n),l.style.top=`${a.top}px`}return s&&(a.scale=Math.max(s,0),l.style.transform=1===s?"":`scale(${s})`),a}updateHeaderButtons(){const t=this._getHeaderButtons();if("boolean"==typeof this.options.headerButtonNoLabel&&this.options.headerButtonNoLabel)for(const e of t)e.label=void 0;u(this,A).call(this,(e=>(e.headerButtons=t,e)))}}function J(){return u(this,I)[0]}function q(){const n=t(this.options);p(this,L,n.update);const i={subscribe:n.subscribe,draggable:e(n,((t,e)=>e(t.draggable))),minimizable:e(n,((t,e)=>e(t.minimizable))),popOut:e(n,((t,e)=>e(t.popOut))),resizable:e(n,((t,e)=>e(t.resizable))),title:e(n,((t,e)=>e(t.title))),zIndex:e(n,((t,e)=>e(Number.isInteger(t.zIndex)?t.zIndex:null)))};Object.freeze(i),p(this,D,i);const s=t({headerButtons:[],minimized:this._minimized});p(this,A,s.update);const o={subscribe:s.subscribe,headerButtons:e(s,((t,e)=>e(t.headerButtons))),minimized:e(s,((t,e)=>e(t.minimized)))};Object.freeze(o),p(this,W,o)}function Q(){u(this,N).push(u(this,D).popOut.subscribe((t=>{t&&this.rendered?ui.windows[this.appId]=this:delete ui.windows[this.appId]}))),u(this,N).push(u(this,D).zIndex.subscribe((t=>{null!==this._element&&(this._element[0].style.zIndex=t)})))}function U(){u(this,N).forEach((t=>t())),p(this,N,[])}function V(t,e,n,s,r){const l="object"==typeof n.options?n.options:{};let a;if(a=n.target instanceof HTMLElement?n.target:"string"==typeof n.target?e.find(n.target).get(0):document.createDocumentFragment(),void 0===a)throw new Error(`SvelteApplication - s_LOAD_CONFIG - could not find target selector: ${n.target} for config:\n${JSON.stringify(n)}`);const h=n.class,u=o(c(c({},n),{},{target:a}),t),p=u.context.get("external");let f;p.foundryApp=t,p.storeAppOptions=s,p.storeUIOptions=r,"object"==typeof t._eventbus&&"function"==typeof t._eventbus.createProxy&&(f=t._eventbus.createProxy(),p.eventbus=f);const d=new h(u);let m;if(u.eventbus=f,i(d)&&(m=d.elementRoot),n.target instanceof DocumentFragment&&a.firstElementChild)void 0===m&&(m=a.firstElementChild),e.append(a);else if(n.target instanceof HTMLElement&&void 0===m){if(n.target instanceof HTMLElement&&"string"!=typeof l.selectorElement)throw new Error(`SvelteApplication - s_LOAD_CONFIG - HTMLElement target with no 'selectorElement' defined for config:\n${JSON.stringify(n)}`);if(m=a.querySelector(l.selectorElement),null==m)throw new Error(`SvelteApplication - s_LOAD_CONFIG - HTMLElement target - could not find 'selectorElement' for config:\n${JSON.stringify(n)}`)}const g={config:u,component:d,element:m,injectHTML:!(n.target instanceof HTMLElement)};return Object.freeze(g),g}var Y=new WeakMap;class K extends G{constructor(t,e){super(e),T(this,Y,{writable:!0,value:void 0}),p(this,Y,t)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dialog"],width:400,svelte:{class:r,intro:!0,target:document.body,props:function(){return{data:u(this,Y)}}}})}get content(){return this.getDialogData("content")}get data(){return u(this,Y)}set content(t){this.setDialogData("content",t)}set data(t){p(this,Y,t);const e=this.svelte.applicationShell;null!=e&&e.data&&(e.data=t)}activateListeners(t){super.activateListeners(t),this.data.render instanceof Function&&this.data.render(this.options.jQuery?t:t[0])}async close(t){return this.data.close instanceof Function&&this.data.close(this.options.jQuery?this.element:this.element[0]),super.close(t)}getDialogData(t,e){return E(u(this,Y),t,e)}mergeDialogData(t){this.data=foundry.utils.mergeObject(u(this,Y),t,{inplace:!1})}setDialogData(t,e){if(z(u(this,Y),t,e)){const t=this.svelte.component(0);null!=t&&t.data&&(t.data=u(this,Y))}}static async confirm({title:t,content:e,yes:n,no:i,render:s,defaultYes:o=!0,rejectClose:r=!1,options:l={},buttons:a={},draggable:c=!0,modal:h=!1,modalOptions:u={},popOut:p=!0,resizable:f=!1,transition:d={},zIndex:m}={}){const g=foundry.utils.mergeObject({yes:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("Yes")},no:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("No")}},a);return new Promise(((a,b)=>{new this({title:t,content:e,render:s,draggable:c,modal:h,modalOptions:u,popOut:p,resizable:f,zIndex:m,transition:d,buttons:foundry.utils.mergeObject(g,{yes:{callback:t=>{const e=!n||n(t);a(e)}},no:{callback:t=>{const e=!!i&&i(t);a(e)}}}),default:o?"yes":"no",close:()=>{r?b("The confirmation Dialog was closed without a choice being made."):a(null)}},l).render(!0)}))}static async prompt({title:t,content:e,label:n,callback:i,render:s,rejectClose:o=!1,options:r={},draggable:l=!0,icon:a='<i class="fas fa-check"></i>',modal:c=!1,modalOptions:h={},popOut:u=!0,resizable:p=!1,transition:f={},zIndex:d}={}){return new Promise(((m,g)=>{new this({title:t,content:e,render:s,draggable:l,modal:c,modalOptions:h,popOut:u,resizable:p,transition:f,zIndex:d,buttons:{ok:{icon:a,label:n,callback:t=>{const e=i?i(t):null;m(e)}}},default:"ok",close:()=>{o?g(new Error("The Dialog prompt was closed without being accepted.")):m(null)}},r).render(!0)}))}}const X=["id","x","y","items","zIndex"];class Z{static createContext(t={}){let{id:e="",x:n=0,y:i=0,items:s=[],zIndex:o=1e4}=t,r=function(t,e){if(null==t)return{};var n,i,s=function(t,e){if(null==t)return{};var n,i,s={},o=Object.keys(t);for(i=0;i<o.length;i++)n=o[i],e.indexOf(n)>=0||(s[n]=t[n]);return s}(t,e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);for(i=0;i<o.length;i++)n=o[i],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(s[n]=t[n])}return s}(t,X);void 0===d(this,Z,tt)&&(m(this,Z,tt,new l({target:document.body,intro:!0,props:{id:e,x:n,y:i,items:s,zIndex:o,transitionOptions:r}})),d(this,Z,tt).$on("close",(()=>{m(this,Z,tt,void 0)})))}}var tt={writable:!0,value:void 0};export{G as SvelteApplication,K as TJSDialog,Z as TJSMenu};

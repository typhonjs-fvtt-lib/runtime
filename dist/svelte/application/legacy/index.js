import{SvelteApplication as t}from"@typhonjs-fvtt/runtime/application";import{ApplicationShell as e}from"@typhonjs-fvtt/runtime/svelte/component/core";import{writable as i,derived as n}from"@typhonjs-fvtt/runtime/svelte/store";import{outroAndDestroy as s,isApplicationShell as o,hasGetter as r,parseSvelteConfig as l}from"@typhonjs-fvtt/runtime/svelte/util";function a(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function h(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?a(Object(i),!0).forEach((function(e){p(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):a(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function p(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function c(t,e){return function(t,e){return e.get?e.get.call(t):e.value}(t,f(t,e,"get"))}function u(t,e,i){return function(t,e,i){if(e.set)e.set.call(t,i);else{if(!e.writable)throw new TypeError("attempted to set read only private field");e.value=i}}(t,f(t,e,"set"),i),i}function f(t,e,i){if(!e.has(t))throw new TypeError("attempted to "+i+" private field on non-instance");return e.get(t)}function m(t,e,i){if(!e.has(t))throw new TypeError("attempted to get private field on non-instance");return i}function d(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function g(t,e,i){d(t,e),e.set(t,i)}function b(t,e){d(t,e),e.add(t)}var v=new WeakMap;class y extends t{constructor(t){super(t),g(this,v,{writable:!0,value:void 0}),this.popOut&&(this.options.svelte=foundry.utils.mergeObject("object"==typeof this.options.svelte?this.options.svelte:{},{class:e,intro:!0,target:document.body}))}async _render(t,e){u(this,v,this.options.popOut),this.options.popOut=!1,await super._render(t,e),this.options.popOut=c(this,v)}_injectHTML(t){var e,i;super._injectHTML(t),null!==(e=this.svelte)&&void 0!==e&&null!==(i=e.applicationShell)&&void 0!==i&&i.elementContent&&this.svelte.applicationShell.elementContent.appendChild(...t)}_replaceHTML(t,e){var i,n;if(t.length)if(super._replaceHTML(t,e),null!==(i=this.svelte)&&void 0!==i&&null!==(n=i.applicationShell)&&void 0!==n&&n.elementContent){const t=this.svelte.applicationShell.elementContent;for(;t.firstChild&&!t.lastChild.remove(););t.appendChild(...e),this.title=this.title}else t.replaceWith(e),this._element=e,this.elementTarget=e[0]}}var w=new WeakMap,O=new WeakMap;class T{constructor(t,e){g(this,w,{writable:!0,value:void 0}),g(this,O,{writable:!0,value:void 0}),u(this,w,t),u(this,O,e)}get applicationShell(){return c(this,w)[0]}component(t){const e=c(this,O)[t];return"object"==typeof e?null==e?void 0:e.component:void 0}*componentEntries(){for(let t=0;t<c(this,O).length;t++)yield[t,c(this,O)[t].component]}*componentValues(){for(let t=0;t<c(this,O).length;t++)yield c(this,O)[t].component}data(t){return c(this,O)[t]}dataEntries(){return c(this,O).entries()}dataValues(){return c(this,O).values()}get length(){return c(this,O).length}}Object.freeze(T);var _=new WeakMap,M=new WeakMap,j=new WeakMap,E=new WeakMap,H=new WeakMap,S=new WeakMap,z=new WeakMap,L=new WeakMap,C=new WeakMap,W=new WeakMap,I=new WeakMap,x=new WeakSet,A=new WeakSet,k=new WeakSet;class N extends FormApplication{constructor(t,e){super(t,e),b(this,k),b(this,A),b(this,x),g(this,M,{get:D,set:void 0}),g(this,_,{writable:!0,value:[null]}),g(this,j,{writable:!0,value:null}),g(this,E,{writable:!0,value:null}),g(this,H,{writable:!0,value:void 0}),g(this,S,{writable:!0,value:void 0}),g(this,z,{writable:!0,value:void 0}),g(this,L,{writable:!0,value:void 0}),g(this,C,{writable:!0,value:[]}),g(this,W,{writable:!0,value:[]}),g(this,I,{writable:!0,value:new T(c(this,_),c(this,W))}),m(this,x,F).call(this)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{draggable:!0,headerButtonNoLabel:!1,jqueryCloseAnimation:!0,zIndex:null})}get draggable(){return this.options.draggable}get elementContent(){return c(this,E)}get elementTarget(){return c(this,j)}get popOut(){return super.popOut}get resizable(){return this.options.resizable}get svelte(){return c(this,I)}get title(){return super.title}get zIndex(){return this.options.zIndex}set draggable(t){"boolean"==typeof t&&this.setOptions("draggable",t)}set elementContent(t){if(!(t instanceof HTMLElement))throw new TypeError("SvelteFormApplication - set elementContent error: 'content' is not an HTMLElement.");u(this,E,t)}set elementTarget(t){if(!(t instanceof HTMLElement))throw new TypeError("SvelteFormApplication - set elementTarget error: 'target' is not an HTMLElement.");u(this,j,t)}set popOut(t){"boolean"==typeof t&&this.setOptions("popOut",t)}set resizable(t){"boolean"==typeof t&&this.setOptions("resizable",t)}set title(t){"string"==typeof t&&this.setOptions("title",t)}set zIndex(t){this.setOptions("zIndex",Number.isInteger(t)?t:null)}async close(t={}){const e=Application.RENDER_STATES;if(!t.force&&![e.RENDERED,e.ERROR].includes(this._state))return;m(this,k,B).call(this),this._state=e.CLOSING;const i=$(c(this,j));if(!i)return this._state=e.CLOSED;for(const t of this.constructor._getInheritanceChain())Hooks.call(`close${t.name}`,this,i);("boolean"!=typeof this.options.jqueryCloseAnimation||this.options.jqueryCloseAnimation)&&(i[0].style.minHeight="0",await new Promise((t=>{i.slideUp(200,(()=>t()))})));const n=[];for(const t of c(this,W)){n.push(s(t.component));const e=t.config.eventbus;"object"==typeof e&&"function"==typeof e.off&&(e.off(),t.config.eventbus=void 0)}await Promise.all(n),c(this,W).length=0,i.remove(),c(this,_)[0]=null,this._element=null,u(this,E,null),u(this,j,null),delete ui.windows[this.appId],this._minimized=!1,this._scrollPositions=null,this._state=e.CLOSED,c(this,L).call(this,(t=>foundry.utils.mergeObject(t,{minimized:this._minimized})))}getOptions(t,e){return function(t,e,i){if("object"!=typeof t)return i;if("string"!=typeof e)return i;const n=e.split(".");for(let e=0;e<n.length;e++){if(void 0===t[n[e]]||null===t[n[e]])return i;t=t[n[e]]}return t}(this.options,t,e)}_injectHTML(t){if(this.popOut&&0===t.length&&Array.isArray(this.options.svelte))throw new Error("SvelteApplication - _injectHTML - A popout app with no template can only support one Svelte component.");if(this.updateHeaderButtons(),Array.isArray(this.options.svelte))for(const e of this.options.svelte){const i=R(this,t,e,c(this,H),c(this,z));if(o(i.component)){if(null!==c(this,M))throw new Error(`SvelteApplication - _injectHTML - An application shell is already mounted; offending config: \n                    ${JSON.stringify(e)}`);c(this,_)[0]=i.component}c(this,W).push(i)}else if("object"==typeof this.options.svelte){const e=R(this,t,this.options.svelte,c(this,H),c(this,z));if(o(e.component)){if(null!==c(this,M))throw new Error(`SvelteApplication - _injectHTML - An application shell is already mounted; offending config: \n                 ${JSON.stringify(this.options.svelte)}`);c(this,_)[0]=e.component}c(this,W).push(e)}const e=t.length&&t[0]instanceof DocumentFragment;let i=!0;for(const t of c(this,W))if(!t.injectHTML){i=!1;break}if(i&&super._injectHTML(t),null!==c(this,M))this._element=$(c(this,M).elementRoot),u(this,E,r(c(this,M),"elementContent")?c(this,M).elementContent:null),u(this,j,r(c(this,M),"elementTarget")?c(this,M).elementTarget:null);else if(e)for(const t of c(this,W))if(t.element instanceof HTMLElement){this._element=$(t.element);break}if(null===c(this,j)){const t="string"==typeof this.options.selectorTarget?this._element.find(this.options.selectorTarget):this._element;u(this,j,t[0])}if(null===c(this,j)||void 0===c(this,j)||0===c(this,j).length)throw new Error(`SvelteApplication - _injectHTML: Target element '${this.options.selectorTarget}' not found.`);setTimeout((()=>m(this,A,P).call(this)),0),this.onSvelteMount({element:this._element[0],elementContent:c(this,E),elementTarget:c(this,j)})}async maximize(){if(this.popOut&&![!1,null].includes(this._minimized))return c(this,L).call(this,(t=>foundry.utils.mergeObject(t,{minimized:!1}))),super.maximize()}async minimize(){if(this.rendered&&this.popOut&&![!0,null].includes(this._minimized))return c(this,L).call(this,(t=>foundry.utils.mergeObject(t,{minimized:!0}))),super.minimize()}mergeOptions(t){c(this,S).call(this,(e=>foundry.utils.mergeObject(e,t)))}onSvelteMount({element:t,elementContent:e,elementTarget:i}){}_replaceHTML(t,e){t.length&&this.updateHeaderButtons()}async _renderInner(t){const e="string"==typeof this.template?await renderTemplate(this.template,t):document.createDocumentFragment();return $(e)}setOptions(t,e){const i=function(t,e,i,n="set",s=!0){if("object"!=typeof t)throw new TypeError("safeSet Error: 'data' is not an 'object'.");if("string"!=typeof e)throw new TypeError("safeSet Error: 'accessor' is not a 'string'.");const o=e.split(".");for(let e=0;e<o.length;e++){if(Array.isArray(t)){const t=+o[e];if(!Number.isInteger(t)||t<0)return!1}if(e===o.length-1)switch(n){case"add":t[o[e]]+=i;break;case"div":t[o[e]]/=i;break;case"mult":t[o[e]]*=i;break;case"set":t[o[e]]=i;break;case"set-undefined":void 0===t[o[e]]&&(t[o[e]]=i);break;case"sub":t[o[e]]-=i}else{if(s&&void 0===t[o[e]]&&(t[o[e]]={}),null===t[o[e]]||"object"!=typeof t[o[e]])return!1;t=t[o[e]]}}return!0}(this.options,t,e);i&&c(this,S).call(this,(()=>this.options))}setPosition({left:t,top:e,width:i,height:n,scale:s,noHeight:o=!1,noWidth:r=!1}={}){const l=this.elementTarget,a=this.position,h=globalThis.getComputedStyle(l);if(!l.style.width||i){const e=i||l.offsetWidth,n=parseInt(h.minWidth)||MIN_WINDOW_WIDTH,s=l.style.maxWidth||globalThis.innerWidth;a.width=i=Math.clamped(e,n,s),r||(l.style.width=`${i}px`),i+a.left>globalThis.innerWidth&&(t=a.left)}if(i=l.offsetWidth,!l.style.height||n){const t=n||l.offsetHeight+1,i=parseInt(h.minHeight)||MIN_WINDOW_HEIGHT,s=l.style.maxHeight||globalThis.innerHeight;a.height=n=Math.clamped(t,i,s),o||(l.style.height=`${n}px`),n+a.top>globalThis.innerHeight+1&&(e=a.top-1)}if(n=l.offsetHeight,!l.style.left||Number.isFinite(t)){const e=Number.isFinite(t)?t:(globalThis.innerWidth-i)/2,n=Math.max(globalThis.innerWidth-i,0);a.left=t=Math.clamped(e,0,n),l.style.left=`${t}px`}if(!l.style.top||Number.isFinite(e)){const t=Number.isFinite(e)?e:(globalThis.innerHeight-n)/2,i=Math.max(globalThis.innerHeight-n,0);a.top=e=Math.clamped(t,0,i),l.style.top=`${a.top}px`}return s&&(a.scale=Math.max(s,0),l.style.transform=1===s?"":`scale(${s})`),a}updateHeaderButtons(){const t=this._getHeaderButtons();if("boolean"==typeof this.options.headerButtonNoLabel&&this.options.headerButtonNoLabel)for(const e of t)e.label=void 0;c(this,L).call(this,(e=>(e.headerButtons=t,e)))}}function D(){return c(this,_)[0]}function F(){const t=i(this.options);u(this,S,t.update);const e={subscribe:t.subscribe,draggable:n(t,((t,e)=>e(t.draggable))),minimizable:n(t,((t,e)=>e(t.minimizable))),popOut:n(t,((t,e)=>e(t.popOut))),resizable:n(t,((t,e)=>e(t.resizable))),title:n(t,((t,e)=>e(t.title))),zIndex:n(t,((t,e)=>e(Number.isInteger(t.zIndex)?t.zIndex:null)))};Object.freeze(e),u(this,H,e);const s=i({headerButtons:[],minimized:this._minimized});u(this,L,s.update);const o={subscribe:s.subscribe,headerButtons:n(s,((t,e)=>e(t.headerButtons))),minimized:n(s,((t,e)=>e(t.minimized)))};Object.freeze(o),u(this,z,o)}function P(){c(this,C).push(c(this,H).popOut.subscribe((t=>{t&&this.rendered?ui.windows[this.appId]=this:delete ui.windows[this.appId]}))),c(this,C).push(c(this,H).zIndex.subscribe((t=>{null!==this._element&&(this._element[0].style.zIndex=t)})))}function B(){c(this,C).forEach((t=>t())),u(this,C,[])}function R(t,e,i,n,s){const r="object"==typeof i.options?i.options:{};let a;if(a=i.target instanceof HTMLElement?i.target:"string"==typeof i.target?e.find(i.target).get(0):document.createDocumentFragment(),void 0===a)throw new Error(`SvelteApplication - s_LOAD_CONFIG - could not find target selector: ${i.target} for config:\n${JSON.stringify(i)}`);const p=i.class,c=l(h(h({},i),{},{target:a}),t),u=c.context.get("external");let f;u.foundryApp=t,u.storeAppOptions=n,u.storeUIOptions=s,"object"==typeof t._eventbus&&"function"==typeof t._eventbus.createProxy&&(f=t._eventbus.createProxy(),u.eventbus=f);const m=new p(c);let d;if(c.eventbus=f,o(m)&&(d=m.elementRoot),i.target instanceof DocumentFragment&&a.firstElementChild)void 0===d&&(d=a.firstElementChild),e.append(a);else if(i.target instanceof HTMLElement&&void 0===d){if(i.target instanceof HTMLElement&&"string"!=typeof r.selectorElement)throw new Error(`SvelteApplication - s_LOAD_CONFIG - HTMLElement target with no 'selectorElement' defined for config:\n${JSON.stringify(i)}`);if(d=a.querySelector(r.selectorElement),null==d)throw new Error(`SvelteApplication - s_LOAD_CONFIG - HTMLElement target - could not find 'selectorElement' for config:\n${JSON.stringify(i)}`)}const g={config:c,component:m,element:d,injectHTML:!(i.target instanceof HTMLElement)};return Object.freeze(g),g}var G=new WeakMap;class J extends N{constructor(t,i){super(t,i),g(this,G,{writable:!0,value:void 0}),this.popOut&&(this.options.svelte=foundry.utils.mergeObject("object"==typeof this.options.svelte?this.options.svelte:{},{class:e,intro:!0,target:document.body}))}async _render(t,e){u(this,G,this.options.popOut),this.options.popOut=!1,await super._render(t,e),this.options.popOut=c(this,G)}async _renderInner(t){const e=await super._renderInner(t);return this.form=e.filter(((t,e)=>e instanceof HTMLFormElement))[0],this.form||(this.form=e.find("form")[0]),e}_injectHTML(t){var e,i;super._injectHTML(t),null!==(e=this.svelte)&&void 0!==e&&null!==(i=e.applicationShell)&&void 0!==i&&i.elementContent&&this.svelte.applicationShell.elementContent.appendChild(...t)}_replaceHTML(t,e){var i,n;if(t.length)if(super._replaceHTML(t,e),null!==(i=this.svelte)&&void 0!==i&&null!==(n=i.applicationShell)&&void 0!==n&&n.elementContent){const t=this.svelte.applicationShell.elementContent;for(;t.firstChild&&!t.lastChild.remove(););t.appendChild(...e),this.title=this.title}else t.replaceWith(e),this._element=e,this.elementTarget=e[0]}}export{y as HandlebarsApplication,J as HandlebarsFormApplication};

let h=!1;function initializePlugins(){h||(h=!0,Promise.resolve().then((function(){return q})))}class e{static getDisableFilePoster(h){return h.getParam("oembed_disable_file_poster",!1)}static getDisableFileSource(h){return h.getParam("oembed_disable_file_source",!1)}static getMediaHeight(h){return h.getParam("oembed_default_height",288)}static getMediaWidth(h){return h.getParam("oembed_default_width",512)}static getUrlResolver(h){return h.getParam("oembed_url_resolver")}static hasDimensions(h){return h.getParam("oembed_dimensions",!0)}static hasLiveEmbeds(h){return h.getParam("oembed_live_embeds",!0)}static hasPoster(h){return h.getParam("oembed_poster",!0)}static shouldFilterHtml(h){return h.getParam("oembed_filter_html",!0)}}const t=(h,g)=>{if(!1===e.shouldFilterHtml(h))return g;const f=tinymce.html.Writer();let v;return tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!1,comment:h=>{v||f.comment(h)},cdata:h=>{v||f.cdata(h)},text:(h,g)=>{v||f.text(h,g)},start:(g,w,j)=>{if(v=!0,"script"!==g&&"noscript"!==g&&"svg"!==g){for(let f=w.length-1;f>=0;f--){const v=w[f].name;0===v.indexOf("on")&&(delete w.map[v],w.splice(f,1)),"style"===v&&(w[f].value=h.dom.serializeStyle(h.dom.parseStyle(w[f].value),g))}f.start(g,w,j),v=!1}},end:h=>{v||f.end(h)}},tinymce.html.Schema({})).parse(g),f.getContent()};let g;class o{static placeHolderConverter(h){return g=>{let f,v=g.length;for(;v--;)f=g[v],f.parent&&!f.parent.attr("data-mce-object")&&(i(f)&&e.hasLiveEmbeds(h)?m(f)||f.replace(a(h,f)):m(f)||f.replace(n(h,f)))}}static setPoster(h){g=h}}const a=(h,f)=>{const v=f.name;void 0!==g&&f.attr("data-oembed-poster",g);const w=new tinymce.html.Node("span",1);w.attr({contentEditable:"false",style:f.attr("style"),"data-mce-object":v,class:`mce-preview-object mce-object-${v}`}),l(h,f,w);const j=h.dom.parseStyle(f.attr("style")),O=new tinymce.html.Node(v,1);if(d(f,O,j),O.attr({src:f.attr("src"),style:f.attr("style"),class:f.attr("class")}),"iframe"===v)O.attr({allowfullscreen:f.attr("allowfullscreen"),frameborder:"0"});else{const g=["controls","crossorigin","currentTime","loop","muted","poster","preload"];for(const h of g)O.attr(h,f.attr(h));const j=w.attr("data-mce-html");null!=j&&((h,g,f,v)=>{const w=tinymce.html.DomParser({forced_root_block:!1,validate:!1},h.schema).parse(v,{context:g});for(;w.firstChild;)f.append(w.firstChild)})(h,v,O,j)}const _=new tinymce.html.Node("span",1);return _.attr("class","mce-shim"),w.append(O),w.append(_),w},n=(h,f)=>{const v=f.name;void 0!==g&&f.attr("data-oembed-poster",g);const w=new tinymce.html.Node("img",1);w.shortEnded=!0,l(h,f,w);const j=f.attr("data-oembed-poster");return d(f,w,{}),w.attr({style:f.attr("style"),src:j||"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7","data-mce-object":v,class:`mce-object mce-object-${v}`}),w},s=(h,g,f,v=null)=>{const w=h.attr(f);return null!=w?w:Object.hasOwnProperty.call(g,f)?null:v},i=h=>{const g=h.name;return"iframe"===g||"video"===g||"audio"===g},c=h=>{const g=h.attr("class");return g&&/\btiny-pageembed\b/.test(g)},m=h=>{for(;h=h.parent;)if(c(h))return!0;return!1},l=(h,g,f)=>{const v=g.attributes;let w=v.length;for(;w--;){const g=v[w].name;let j=v[w].value;"width"!==g&&"height"!==g&&"style"!==g&&("data"!==g&&"src"!==g||(j=h.convertURL(j,g)),f.attr(`data-mce-p-${g}`,j))}const j=g.firstChild&&g.firstChild.value;j&&(f.attr("data-mce-html",escape(t(h,j))),f.firstChild=null)},d=(h,g,f)=>{const v="img"===g.name||"video"===h.name,w=v?"300":null,j="audio"===h.name?"30":"150",O=v?j:null;g.attr({width:s(h,f,"width",w),height:s(h,f,"height",O)})},u=(h,g)=>{const f=Object.keys(g);for(let v=0,w=f.length;v<w;v++){const w=f[v],j=`${g[w]}`;if(h.map[w]){let g=h.length;for(;g--;){const f=h[g];f.name===w&&(j?(h.map[w]=j,f.value=j):(delete h.map[w],h.splice(g,1)))}}else j&&(h.push({name:w,value:j}),h.map[w]=j)}},f=["source"],p=(h,g,v)=>{const w=tinymce.html.Writer();let j,O=0;return tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,comment:h=>{w.comment(h)},cdata:h=>{w.cdata(h)},text:(h,g)=>{w.text(h,g)},start:(h,_,S)=>{switch(h){case"video":case"object":case"embed":case"img":case"iframe":void 0!==g.height&&void 0!==g.width&&u(_,{width:g.width,height:g.height})}if(v)switch(h){case"video":u(_,{poster:g.poster,src:""});break;case"iframe":u(_,{src:g.source});break;case"source":if(O<2&&(u(_,{src:g[f[O]],type:g[`${f[O]}mime`]}),!g[f[O]]))return;O++;break;case"img":if(!g.poster)return;j=!0}w.start(h,_,S)},end:h=>{if("video"===h&&v)for(let h=0;h<2;h++)if(g[f[h]]){const v=[];v.map={},O<=h&&(u(v,{src:g[f[h]],type:g[`${f[h]}mime`]}),w.start("source",v,!0))}if(g.poster&&"object"===h&&v&&!j){const h=[];h.map={},u(h,{src:g.poster,width:g.width,height:g.height}),w.start("img",h,!0)}w.end(h)}},tinymce.html.Schema({})).parse(h),w.getContent()},b=(h,g)=>f=>h.selection.selectorChangedWithUnbind(g.join(","),f.setActive).unbind;var v,w,y=function(h){return function(){return h}},j=y(!1),O=y(!0),A=function(){return _},_={fold:function(h,g){return h()},isSome:j,isNone:O,getOr:w=function(h){return h},getOrThunk:v=function(h){return h()},getOrDie:function(h){throw new Error(h||"error: getOrDie called on none.")},getOrNull:y(null),getOrUndefined:y(void 0),or:w,orThunk:v,map:A,each:function(){},bind:A,exists:j,forall:O,filter:function(){return A()},toArray:function(){return[]},toString:y("none()")},x=function(h){var g=y(h),r=function(){return f},o=function(g){return g(h)},f={fold:function(g,f){return f(h)},isSome:O,isNone:j,getOr:g,getOrThunk:g,getOrDie:g,getOrNull:g,getOrUndefined:g,or:r,orThunk:r,map:function(g){return x(g(h))},each:function(g){g(h)},bind:o,exists:o,forall:o,filter:function(g){return g(h)?f:_},toArray:function(){return[h]},toString:function(){return"some("+h+")"}};return f},S={some:x,none:A,from:function(h){return null==h?_:x(h)}},M=Object.hasOwnProperty,C=function(h,g){return P(h,g)?S.from(h[g]):S.none()},P=function(h,g){return M.call(h,g)};const D=h=>{let g={};return tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,start:(h,f)=>{g.source||"param"!==h||(g.source=f.map.movie),"iframe"!==h&&"object"!==h&&"embed"!==h&&"video"!==h&&"audio"!==h||(g.type||(g.type=h),g=Object.assign({},f.map,g)),"source"===h&&(g.source||(g.source=f.map.src)),"img"!==h||g.poster||(g.poster=f.map.src),void 0!==f.map["data-oembed-poster"]&&(g.poster=f.map["data-oembed-poster"])}}).parse(h),g.source=g.source||g.src||g.data,g.poster=g.poster||"",g},E=new Map,V=[{name:"Vimeo",regex:/^(https:\/\/vimeo.com\/(.*)|https:\/\/vimeo.com\/album\/(.*)\/video\/(.*)|https:\/\/vimeo.com\/channels\/(.*)\/(.*)|https:\/\/vimeo.com\/groups\/(.*)\/videos\/(.*)|https:\/\/vimeo.com\/ondemand\/(.*)\/(.*)|https:\/\/player.vimeo.com\/video\/(.*))/,url:(h,g,f)=>`https://vimeo.com/api/oembed.json?url=${h}&maxwidth=${g}&maxheight=${f}`},{name:"YouTube",regex:/^(https:\/\/(.*).youtube.com\/watch(.*)|https:\/\/(.*).youtube.com\/v\/(.*)|https:\/\/youtu.be\/(.*)|https:\/\/(.*).youtube.com\/playlist?list=(.*))/,url:(h,g,f)=>`https://www.youtube.com/oembed?url=${h}&format=json&maxwidth=${g}&maxheight=${f}`}];class k{static async getEmbedHtml(h,g){let f;if(E.has(g.source))return E.get(g.source);const v=e.getUrlResolver(h);if(v)try{const h=await v({url:g.source});f={url:g.source,html:h.html,poster:h.poster}}catch(g){const f=g.msg||g.message||"Unknown error.";return void h.notificationManager.open({type:"error",text:`Media embed error: ${f}`})}else{let v,w;const j=e.getMediaWidth(h),O=e.getMediaHeight(h);for(const h of V)h.regex.exec(g.source)&&(w=h.url(g.source,j,O),v=h.name);if(void 0===w)return void h.notificationManager.open({type:"error",text:"Media embed error: URL did not match any providers available."});const _=await window.fetch(w);if(!_||200!==_.status)return void h.notificationManager.open({type:"error",text:`Media embed error: Could not fetch ${v} embed URL.`});const S=await _.json();if(void 0===S.html){const g=S.error?S.error:`Could not fetch ${v} embed URL.`;return void h.notificationManager.open({type:"error",text:`Media embed error: ${g}`})}f={url:g.source,html:S.html,poster:S.thumbnail_url}}return E.set(g.source,f),f}static isCached(h){return E.has(h)}}class ${static showDialog(h){const g=U(h);let f=g;const v=Q(g),w=e.getDisableFilePoster(h),j=e.getDisableFileSource(h),O=[];O.push({name:"source",type:"urlinput",filetype:j?void 0:"media",label:"Source"}),e.hasDimensions(h)&&O.push({type:"sizeinput",name:"dimensions",label:"Constrain proportions",constrain:!0}),O.push({name:"poster",type:"urlinput",filetype:w?void 0:"image",label:"Media poster (Image URL)"}),O.push({name:"embed",type:"textarea",label:"Generated Embed:",disabled:!0});const _={type:"panel",items:O};h.windowManager.open({title:"Insert/Edit Media (oEmbed)",size:"normal",body:_,buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],onSubmit:async g=>{const v=$.unwrap(g.getData());await J(f,v,h),g.close()},onChange:async(g,v)=>{try{switch(v.name){case"source":await F(f,g,h);break;case"embed":L(g,h);break;case"dimensions":case"poster":z(g,v.name)}f=$.unwrap(g.getData())}catch(g){console.log(g)}},initialData:v},void 0)}static unwrap(h,g){const f=g?T(g,h).getOr({}):{},v=H(h,f,g);return{...v("source"),...v("poster"),...v("embed"),...R(h,f)}}}const Y=["width","height"],N=(h,g,f)=>{if("string"==typeof h.url&&h.url.trim().length>0){const v=h.html,w={...G(f,v),source:h.url,embed:v,poster:h.poster};g.setData(Q(w))}},T=(h,g)=>C(g,h).bind((h=>C(h,"meta"))),R=(h,g)=>{const f={};return C(h,"dimensions").each((h=>{for(const v of Y)C(g,v).orThunk((()=>C(h,v))).each((h=>f[v]=h))})),f},U=h=>{const g=h.selection.getNode(),f=B(g)?h.serializer.serialize(g,{selection:!0}):"";return{embed:f,...D(f)}},H=(h,g,f)=>v=>{const a=()=>C(h,v),n=()=>C(g,v),s=h=>C(h,"value").bind((h=>h.length>0?S.some(h):S.none()));return{[v]:(v===f?a().bind((h=>"object"==typeof h?s(h).orThunk(n):n().orThunk((()=>S.from(h))))):n().orThunk((()=>a().bind((h=>"object"==typeof h?s(h):S.from(h)))))).getOr("")}},F=async(h,g,f)=>{const v=$.unwrap(g.getData(),"source");if(h.source!==v.source){N({url:v.source,html:"",poster:""},g,f);const h=await k.getEmbedHtml(f,v);h&&N(h,g,f)}},L=(h,g)=>{const f=$.unwrap(h.getData()),v=G(g,f.embed);h.setData(Q(v))},z=(h,g)=>{const f=$.unwrap(h.getData(),g),v=f.embed?p(f.embed,f,!1):"";h.setData(Q({...f,embed:v}))},I=(h,g,f)=>{const v=h.dom.select("*[data-mce-object]");o.setPoster(f.poster),h.insertContent(g),o.setPoster(void 0),W(h,v).dataset.oembedPoster=f.poster,h.nodeChanged()},B=h=>h.getAttribute("data-mce-object"),W=(h,g)=>{const f=h.dom.select("*[data-mce-object]");for(let h=0;h<g.length;h++)for(let v=f.length-1;v>=0;v--)g[h]===f[v]&&f.splice(v,1);return h.selection.select(f[0]),f[0]},G=(h,g)=>D(g),J=async(h,g,f)=>{if(g.embed=p(g.embed,g),g.embed&&(h.source===g.source||k.isCached(g.source)))I(f,g.embed,g);else{const h=await k.getEmbedHtml(f,g);h&&I(f,h.html,g)}},Q=h=>{const g={...h,source:{value:C(h,"source").getOr("")},poster:{value:C(h,"poster").getOr("")}};for(const f of Y)C(h,f).each((h=>{const v=g.dimensions||{};v[f]=h,g.dimensions=v}));return g};tinymce.PluginManager.add("typhonjs-oembed",class{constructor(h){h.addCommand("typhonjsOembed",(()=>$.showDialog(h))),class{static register(h){h.ui.registry.addToggleButton("typhonjs-oembed",{tooltip:"Insert/edit media",icon:"embed",onAction:()=>{h.execCommand("typhonjsOembed")},onSetup:b(h,["img[data-mce-object]","span[data-mce-object]"])}),h.ui.registry.addMenuItem("typhonjs-oembed",{icon:"embed",text:"Media...",onAction:()=>{h.execCommand("typhonjsOembed")}})}}.register(h),class{static setup(h){h.on("ResolveName",(h=>{let g;1===h.target.nodeType&&(g=h.target.getAttribute("data-mce-object"))&&(h.name=g)}))}}.setup(h),class{static setup(h){h.on("preInit",(()=>{h.parser.addNodeFilter("iframe,video,audio,object,embed",o.placeHolderConverter(h)),h.serializer.addAttributeFilter("data-mce-object",((g,f)=>{let v,w,j,O,_,S,M,E,V=g.length;for(;V--;)if(v=g[V],v.parent){for(M=v.attr(f),w=new tinymce.html.Node(M,1),"audio"!==M&&(E=v.attr("class"),E&&-1!==E.indexOf("mce-preview-object")?w.attr({width:v.firstChild.attr("width"),height:v.firstChild.attr("height")}):w.attr({width:v.attr("width"),height:v.attr("height")})),w.attr({style:v.attr("style")}),O=v.attributes,j=O.length;j--;){const h=O[j].name;0===h.indexOf("data-mce-p-")&&w.attr(h.substr(11),O[j].value)}_=v.attr("data-mce-html"),_&&(S=new tinymce.html.Node("#text",3),S.raw=!0,S.value=t(h,unescape(_)),w.append(S)),v.replace(w)}}))}))}}.setup(h),class{static setup(h){h.on("click keyup touchend",(()=>{const g=h.selection.getNode();g&&h.dom.hasClass(g,"mce-preview-object")&&h.dom.getAttrib(g,"data-mce-selected")&&g.setAttribute("data-mce-selected","2")})),h.on("ObjectSelected",(h=>{"script"===h.target.getAttribute("data-mce-object")&&h.preventDefault()})),h.on("ObjectResized",(h=>{const g=h.target;let f;g.getAttribute("data-mce-object")&&(f=g.getAttribute("data-mce-html"),f&&(f=unescape(f),g.setAttribute("data-mce-html",escape(p(f,{width:String(h.width),height:String(h.height)})))))}))}}.setup(h)}getMetadata(){return{name:"TyphonJS oEmbed",url:"https://github.com/typhonjs-tinymce/oembed"}}});const q=Object.freeze({__proto__:null});export{initializePlugins};
//# sourceMappingURL=initializePlugins.js.map

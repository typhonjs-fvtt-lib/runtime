import{writable as e,derived as t}from"/modules/typhonjs/svelte/store.js";import{outroAndDestroy as i,isApplicationShell as s,hasGetter as n,parseSvelteConfig as a}from"/modules/typhonjs/svelte/util.js";import{DialogShell as l,TJSContextMenu as r}from"/modules/typhonjs/svelte/component/core.js";function ownKeys(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,s)}return i}function _objectSpread2(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(i),!0).forEach((function(t){_defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ownKeys(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _classPrivateFieldGet(e,t){return _classApplyDescriptorGet(e,_classExtractFieldDescriptor(e,t,"get"))}function _classPrivateFieldSet(e,t,i){return _classApplyDescriptorSet(e,_classExtractFieldDescriptor(e,t,"set"),i),i}function _classExtractFieldDescriptor(e,t,i){if(!t.has(e))throw new TypeError("attempted to "+i+" private field on non-instance");return t.get(e)}function _classStaticPrivateFieldSpecGet(e,t,i){return _classCheckPrivateStaticAccess(e,t),_classCheckPrivateStaticFieldDescriptor(i,"get"),_classApplyDescriptorGet(e,i)}function _classStaticPrivateFieldSpecSet(e,t,i,s){return _classCheckPrivateStaticAccess(e,t),_classCheckPrivateStaticFieldDescriptor(i,"set"),_classApplyDescriptorSet(e,i,s),s}function _classApplyDescriptorGet(e,t){return t.get?t.get.call(e):t.value}function _classApplyDescriptorSet(e,t,i){if(t.set)t.set.call(e,i);else{if(!t.writable)throw new TypeError("attempted to set read only private field");t.value=i}}function _classCheckPrivateStaticAccess(e,t){if(e!==t)throw new TypeError("Private static access of wrong provenance")}function _classCheckPrivateStaticFieldDescriptor(e,t){if(void 0===e)throw new TypeError("attempted to "+t+" private static field before its declaration")}function _classPrivateMethodGet(e,t,i){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return i}function _checkPrivateRedeclaration(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function _classPrivateFieldInitSpec(e,t,i){_checkPrivateRedeclaration(e,t),t.set(e,i)}function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration(e,t),t.add(e)}function safeAccess(e,t,i){if("object"!=typeof e)return i;if("string"!=typeof t)return i;const s=t.split(".");for(let t=0;t<s.length;t++){if(void 0===e[s[t]]||null===e[s[t]])return i;e=e[s[t]]}return e}function safeSet(e,t,i,s="set",n=!0){if("object"!=typeof e)throw new TypeError("safeSet Error: 'data' is not an 'object'.");if("string"!=typeof t)throw new TypeError("safeSet Error: 'accessor' is not a 'string'.");const a=t.split(".");for(let t=0;t<a.length;t++){if(Array.isArray(e)){const e=+a[t];if(!Number.isInteger(e)||e<0)return!1}if(t===a.length-1)switch(s){case"add":e[a[t]]+=i;break;case"div":e[a[t]]/=i;break;case"mult":e[a[t]]*=i;break;case"set":e[a[t]]=i;break;case"set-undefined":void 0===e[a[t]]&&(e[a[t]]=i);break;case"sub":e[a[t]]-=i}else{if(n&&void 0===e[a[t]]&&(e[a[t]]={}),null===e[a[t]]||"object"!=typeof e[a[t]])return!1;e=e[a[t]]}}return!0}var o=new WeakMap,c=new WeakMap;class GetSvelteData{constructor(e,t){_classPrivateFieldInitSpec(this,o,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,c,{writable:!0,value:void 0}),_classPrivateFieldSet(this,o,e),_classPrivateFieldSet(this,c,t)}get applicationShell(){return _classPrivateFieldGet(this,o)[0]}component(e){const t=_classPrivateFieldGet(this,c)[e];return"object"==typeof t?null==t?void 0:t.component:void 0}*componentEntries(){for(let e=0;e<_classPrivateFieldGet(this,c).length;e++)yield[e,_classPrivateFieldGet(this,c)[e].component]}*componentValues(){for(let e=0;e<_classPrivateFieldGet(this,c).length;e++)yield _classPrivateFieldGet(this,c)[e].component}data(e){return _classPrivateFieldGet(this,c)[e]}dataEntries(){return _classPrivateFieldGet(this,c).entries()}dataValues(){return _classPrivateFieldGet(this,c).values()}get length(){return _classPrivateFieldGet(this,c).length}}Object.freeze(GetSvelteData);var d=new WeakMap,p=new WeakMap,h=new WeakMap,u=new WeakMap,f=new WeakMap,v=new WeakMap,m=new WeakMap,_=new WeakMap,g=new WeakMap,b=new WeakMap,P=new WeakMap,y=new WeakSet,F=new WeakSet,S=new WeakSet;class SvelteApplication extends Application{constructor(e){super(e),_classPrivateMethodInitSpec(this,S),_classPrivateMethodInitSpec(this,F),_classPrivateMethodInitSpec(this,y),_classPrivateFieldInitSpec(this,p,{get:_get_applicationShell,set:void 0}),_classPrivateFieldInitSpec(this,d,{writable:!0,value:[null]}),_classPrivateFieldInitSpec(this,h,{writable:!0,value:null}),_classPrivateFieldInitSpec(this,u,{writable:!0,value:null}),_classPrivateFieldInitSpec(this,f,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,v,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,m,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,_,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,g,{writable:!0,value:[]}),_classPrivateFieldInitSpec(this,b,{writable:!0,value:[]}),_classPrivateFieldInitSpec(this,P,{writable:!0,value:new GetSvelteData(_classPrivateFieldGet(this,d),_classPrivateFieldGet(this,b))}),_classPrivateMethodGet(this,y,_storesInitialize2).call(this)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{draggable:!0,headerButtonNoLabel:!1,jqueryCloseAnimation:!0,zIndex:null})}get draggable(){return this.options.draggable}get elementContent(){return _classPrivateFieldGet(this,u)}get elementTarget(){return _classPrivateFieldGet(this,h)}get minimizable(){return this.options.minimizable}get popOut(){return super.popOut}get resizable(){return this.options.resizable}get svelte(){return _classPrivateFieldGet(this,P)}get title(){return super.title}get zIndex(){return this.options.zIndex}set draggable(e){"boolean"==typeof e&&this.setOptions("draggable",e)}set elementContent(e){if(!(e instanceof HTMLElement))throw new TypeError("SvelteApplication - set elementContent error: 'content' is not an HTMLElement.");_classPrivateFieldSet(this,u,e)}set elementTarget(e){if(!(e instanceof HTMLElement))throw new TypeError("SvelteApplication - set elementTarget error: 'target' is not an HTMLElement.");_classPrivateFieldSet(this,h,e)}set minimizable(e){"boolean"==typeof e&&this.setOptions("minimizable",e)}set popOut(e){"boolean"==typeof e&&this.setOptions("popOut",e)}set resizable(e){"boolean"==typeof e&&this.setOptions("resizable",e)}set title(e){"string"==typeof e&&this.setOptions("title",e)}set zIndex(e){this.setOptions("zIndex",Number.isInteger(e)?e:null)}async close(e={}){const t=Application.RENDER_STATES;if(!e.force&&![t.RENDERED,t.ERROR].includes(this._state))return;_classPrivateMethodGet(this,S,_storesUnsubscribe2).call(this),this._state=t.CLOSING;const s=$(_classPrivateFieldGet(this,h));if(!s)return this._state=t.CLOSED;for(const e of this.constructor._getInheritanceChain())Hooks.call(`close${e.name}`,this,s);("boolean"!=typeof this.options.jqueryCloseAnimation||this.options.jqueryCloseAnimation)&&(s[0].style.minHeight="0",await new Promise((e=>{s.slideUp(200,(()=>e()))})));const n=[];for(const e of _classPrivateFieldGet(this,b)){n.push(i(e.component));const t=e.config.eventbus;"object"==typeof t&&"function"==typeof t.off&&(t.off(),e.config.eventbus=void 0)}await Promise.all(n),_classPrivateFieldGet(this,b).length=0,s.remove(),_classPrivateFieldGet(this,d)[0]=null,this._element=null,_classPrivateFieldSet(this,u,null),_classPrivateFieldSet(this,h,null),delete ui.windows[this.appId],this._minimized=!1,this._scrollPositions=null,this._state=t.CLOSED,_classPrivateFieldGet(this,_).call(this,(e=>foundry.utils.mergeObject(e,{minimized:this._minimized})))}getOptions(e,t){return safeAccess(this.options,e,t)}_injectHTML(e){if(this.popOut&&0===e.length&&Array.isArray(this.options.svelte))throw new Error("SvelteApplication - _injectHTML - A popout app with no template can only support one Svelte component.");if(this.updateHeaderButtons(),Array.isArray(this.options.svelte))for(const t of this.options.svelte){const i=s_LOAD_CONFIG(this,e,t,_classPrivateFieldGet(this,f),_classPrivateFieldGet(this,m));if(s(i.component)){if(null!==_classPrivateFieldGet(this,p))throw new Error(`SvelteApplication - _injectHTML - An application shell is already mounted; offending config: \n                    ${JSON.stringify(t)}`);_classPrivateFieldGet(this,d)[0]=i.component}_classPrivateFieldGet(this,b).push(i)}else if("object"==typeof this.options.svelte){const t=s_LOAD_CONFIG(this,e,this.options.svelte,_classPrivateFieldGet(this,f),_classPrivateFieldGet(this,m));if(s(t.component)){if(null!==_classPrivateFieldGet(this,p))throw new Error(`SvelteApplication - _injectHTML - An application shell is already mounted; offending config: \n                 ${JSON.stringify(this.options.svelte)}`);_classPrivateFieldGet(this,d)[0]=t.component}_classPrivateFieldGet(this,b).push(t)}const t=e.length&&e[0]instanceof DocumentFragment;let i=!0;for(const e of _classPrivateFieldGet(this,b))if(!e.injectHTML){i=!1;break}if(i&&super._injectHTML(e),null!==_classPrivateFieldGet(this,p))this._element=$(_classPrivateFieldGet(this,p).elementRoot),_classPrivateFieldSet(this,u,n(_classPrivateFieldGet(this,p),"elementContent")?_classPrivateFieldGet(this,p).elementContent:null),_classPrivateFieldSet(this,h,n(_classPrivateFieldGet(this,p),"elementTarget")?_classPrivateFieldGet(this,p).elementTarget:null);else if(t)for(const e of _classPrivateFieldGet(this,b))if(e.element instanceof HTMLElement){this._element=$(e.element);break}if(null===_classPrivateFieldGet(this,h)){const e="string"==typeof this.options.selectorTarget?this._element.find(this.options.selectorTarget):this._element;_classPrivateFieldSet(this,h,e[0])}if(null===_classPrivateFieldGet(this,h)||void 0===_classPrivateFieldGet(this,h)||0===_classPrivateFieldGet(this,h).length)throw new Error(`SvelteApplication - _injectHTML: Target element '${this.options.selectorTarget}' not found.`);setTimeout((()=>_classPrivateMethodGet(this,F,_storesSubscribe2).call(this)),0),this.onSvelteMount({element:this._element[0],elementContent:_classPrivateFieldGet(this,u),elementTarget:_classPrivateFieldGet(this,h)})}async maximize(){if(this.popOut&&![!1,null].includes(this._minimized))return _classPrivateFieldGet(this,_).call(this,(e=>foundry.utils.mergeObject(e,{minimized:!1}))),super.maximize()}async minimize(){if(this.rendered&&this.popOut&&![!0,null].includes(this._minimized))return _classPrivateFieldGet(this,_).call(this,(e=>foundry.utils.mergeObject(e,{minimized:!0}))),super.minimize()}mergeOptions(e){_classPrivateFieldGet(this,v).call(this,(t=>foundry.utils.mergeObject(t,e)))}onSvelteMount({element:e,elementContent:t,elementTarget:i}){}_replaceHTML(e,t){e.length&&this.updateHeaderButtons()}async _renderInner(e){const t="string"==typeof this.template?await renderTemplate(this.template,e):document.createDocumentFragment();return $(t)}setOptions(e,t){safeSet(this.options,e,t)&&_classPrivateFieldGet(this,v).call(this,(()=>this.options))}setPosition({left:e,top:t,width:i,height:s,scale:n,noHeight:a=!1,noWidth:l=!1}={}){const r=this.elementTarget,o=this.position,c=globalThis.getComputedStyle(r);if(!r.style.width||i){const t=i||r.offsetWidth,s=parseInt(c.minWidth)||MIN_WINDOW_WIDTH,n=r.style.maxWidth||globalThis.innerWidth;o.width=i=Math.clamped(t,s,n),l||(r.style.width=`${i}px`),i+o.left>globalThis.innerWidth&&(e=o.left)}if(i=r.offsetWidth,!r.style.height||s){const e=s||r.offsetHeight+1,i=parseInt(c.minHeight)||MIN_WINDOW_HEIGHT,n=r.style.maxHeight||globalThis.innerHeight;o.height=s=Math.clamped(e,i,n),a||(r.style.height=`${s}px`),s+o.top>globalThis.innerHeight+1&&(t=o.top-1)}if(s=r.offsetHeight,!r.style.left||Number.isFinite(e)){const t=Number.isFinite(e)?e:(globalThis.innerWidth-i)/2,s=Math.max(globalThis.innerWidth-i,0);o.left=e=Math.clamped(t,0,s),r.style.left=`${e}px`}if(!r.style.top||Number.isFinite(t)){const e=Number.isFinite(t)?t:(globalThis.innerHeight-s)/2,i=Math.max(globalThis.innerHeight-s,0);o.top=t=Math.clamped(e,0,i),r.style.top=`${o.top}px`}return n&&(o.scale=Math.max(n,0),r.style.transform=1===n?"":`scale(${n})`),o}updateHeaderButtons(){const e=this._getHeaderButtons();if("boolean"==typeof this.options.headerButtonNoLabel&&this.options.headerButtonNoLabel)for(const t of e)t.label=void 0;_classPrivateFieldGet(this,_).call(this,(t=>(t.headerButtons=e,t)))}}function _get_applicationShell(){return _classPrivateFieldGet(this,d)[0]}function _storesInitialize2(){const i=e(this.options);_classPrivateFieldSet(this,v,i.update);const s={subscribe:i.subscribe,draggable:t(i,((e,t)=>t(e.draggable))),minimizable:t(i,((e,t)=>t(e.minimizable))),popOut:t(i,((e,t)=>t(e.popOut))),resizable:t(i,((e,t)=>t(e.resizable))),title:t(i,((e,t)=>t(e.title))),zIndex:t(i,((e,t)=>t(Number.isInteger(e.zIndex)?e.zIndex:null)))};Object.freeze(s),_classPrivateFieldSet(this,f,s);const n=e({headerButtons:[],minimized:this._minimized});_classPrivateFieldSet(this,_,n.update);const a={subscribe:n.subscribe,headerButtons:t(n,((e,t)=>t(e.headerButtons))),minimized:t(n,((e,t)=>t(e.minimized)))};Object.freeze(a),_classPrivateFieldSet(this,m,a)}function _storesSubscribe2(){_classPrivateFieldGet(this,g).push(_classPrivateFieldGet(this,f).popOut.subscribe((e=>{e&&this.rendered?ui.windows[this.appId]=this:delete ui.windows[this.appId]}))),_classPrivateFieldGet(this,g).push(_classPrivateFieldGet(this,f).zIndex.subscribe((e=>{null!==this._element&&(this._element[0].style.zIndex=e)})))}function _storesUnsubscribe2(){_classPrivateFieldGet(this,g).forEach((e=>e())),_classPrivateFieldSet(this,g,[])}function s_LOAD_CONFIG(e,t,i,n,l){const r="object"==typeof i.options?i.options:{};let o;if(o=i.target instanceof HTMLElement?i.target:"string"==typeof i.target?t.find(i.target).get(0):document.createDocumentFragment(),void 0===o)throw new Error(`SvelteApplication - s_LOAD_CONFIG - could not find target selector: ${i.target} for config:\n${JSON.stringify(i)}`);const c=i.class,d=a(_objectSpread2(_objectSpread2({},i),{},{target:o}),e),p=d.context.get("external");let h;p.foundryApp=e,p.storeAppOptions=n,p.storeUIOptions=l,"object"==typeof e._eventbus&&"function"==typeof e._eventbus.createProxy&&(h=e._eventbus.createProxy(),p.eventbus=h);const u=new c(d);let f;if(d.eventbus=h,s(u)&&(f=u.elementRoot),i.target instanceof DocumentFragment&&o.firstElementChild)void 0===f&&(f=o.firstElementChild),t.append(o);else if(i.target instanceof HTMLElement&&void 0===f){if(i.target instanceof HTMLElement&&"string"!=typeof r.selectorElement)throw new Error(`SvelteApplication - s_LOAD_CONFIG - HTMLElement target with no 'selectorElement' defined for config:\n${JSON.stringify(i)}`);if(f=o.querySelector(r.selectorElement),null==f)throw new Error(`SvelteApplication - s_LOAD_CONFIG - HTMLElement target - could not find 'selectorElement' for config:\n${JSON.stringify(i)}`)}const v={config:d,component:u,element:f,injectHTML:!(i.target instanceof HTMLElement)};return Object.freeze(v),v}var w=new WeakMap;class TJSDialog extends SvelteApplication{constructor(e,t){super(t),_classPrivateFieldInitSpec(this,w,{writable:!0,value:void 0}),_classPrivateFieldSet(this,w,e)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dialog"],width:400,svelte:{class:l,intro:!0,target:document.body,props:function(){return{data:_classPrivateFieldGet(this,w)}}}})}get content(){return this.getDialogData("content")}get data(){return _classPrivateFieldGet(this,w)}set content(e){this.setDialogData("content",e)}set data(e){_classPrivateFieldSet(this,w,e);const t=this.svelte.applicationShell;null!=t&&t.data&&(t.data=e)}activateListeners(e){super.activateListeners(e),this.data.render instanceof Function&&this.data.render(this.options.jQuery?e:e[0])}async close(e){return this.data.close instanceof Function&&this.data.close(this.options.jQuery?this.element:this.element[0]),super.close(e)}getDialogData(e,t){return safeAccess(_classPrivateFieldGet(this,w),e,t)}mergeDialogData(e){this.data=foundry.utils.mergeObject(_classPrivateFieldGet(this,w),e,{inplace:!1})}setDialogData(e,t){if(safeSet(_classPrivateFieldGet(this,w),e,t)){const e=this.svelte.component(0);null!=e&&e.data&&(e.data=_classPrivateFieldGet(this,w))}}static async confirm({title:e,content:t,yes:i,no:s,render:n,defaultYes:a=!0,rejectClose:l=!1,options:r={},buttons:o={},draggable:c=!0,modal:d=!1,modalOptions:p={},popOut:h=!0,resizable:u=!1,transition:f={},zIndex:v}={}){const m=foundry.utils.mergeObject({yes:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("Yes")},no:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("No")}},o);return new Promise(((o,_)=>{new this({title:e,content:t,render:n,draggable:c,modal:d,modalOptions:p,popOut:h,resizable:u,zIndex:v,transition:f,buttons:foundry.utils.mergeObject(m,{yes:{callback:e=>{const t=!i||i(e);o(t)}},no:{callback:e=>{const t=!!s&&s(e);o(t)}}}),default:a?"yes":"no",close:()=>{l?_("The confirmation Dialog was closed without a choice being made."):o(null)}},r).render(!0)}))}static async prompt({title:e,content:t,label:i,callback:s,render:n,rejectClose:a=!1,options:l={},draggable:r=!0,icon:o='<i class="fas fa-check"></i>',modal:c=!1,modalOptions:d={},popOut:p=!0,resizable:h=!1,transition:u={},zIndex:f}={}){return new Promise(((v,m)=>{new this({title:e,content:t,render:n,draggable:r,modal:c,modalOptions:d,popOut:p,resizable:h,transition:u,zIndex:f,buttons:{ok:{icon:o,label:i,callback:e=>{const t=s?s(e):null;v(t)}}},default:"ok",close:()=>{a?m(new Error("The Dialog prompt was closed without being accepted.")):v(null)}},l).render(!0)}))}}const O=["id","x","y","items","zIndex"];class TJSMenu{static createContext(e={}){let{id:t="",x:i=0,y:s=0,items:n=[],zIndex:a=1e4}=e,l=function(e,t){if(null==e)return{};var i,s,n=function(e,t){if(null==e)return{};var i,s,n={},a=Object.keys(e);for(s=0;s<a.length;s++)i=a[s],t.indexOf(i)>=0||(n[i]=e[i]);return n}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(s=0;s<a.length;s++)i=a[s],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(n[i]=e[i])}return n}(e,O);void 0===_classStaticPrivateFieldSpecGet(this,TJSMenu,G)&&(_classStaticPrivateFieldSpecSet(this,TJSMenu,G,new r({target:document.body,intro:!0,props:{id:t,x:i,y:s,items:n,zIndex:a,transitionOptions:_objectSpread2({duration:200},l)}})),_classStaticPrivateFieldSpecGet(this,TJSMenu,G).$on("close",(()=>{_classStaticPrivateFieldSpecSet(this,TJSMenu,G,void 0)})))}}var G={writable:!0,value:void 0};export{SvelteApplication,TJSDialog,TJSMenu};
//# sourceMappingURL=application.js.map

import{SvelteApplication as e}from"/modules/typhonjs/svelte/application.js";import{ApplicationShell as t}from"/modules/typhonjs/svelte/component/core.js";import{writable as i,derived as s}from"/modules/typhonjs/svelte/store.js";import{outroAndDestroy as l,isApplicationShell as n,hasGetter as a,parseSvelteConfig as r}from"/modules/typhonjs/svelte/util.js";function ownKeys(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,s)}return i}function _objectSpread2(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(i),!0).forEach((function(t){_defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ownKeys(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _classPrivateFieldGet(e,t){return function(e,t){return t.get?t.get.call(e):t.value}(e,_classExtractFieldDescriptor(e,t,"get"))}function _classPrivateFieldSet(e,t,i){return function(e,t,i){if(t.set)t.set.call(e,i);else{if(!t.writable)throw new TypeError("attempted to set read only private field");t.value=i}}(e,_classExtractFieldDescriptor(e,t,"set"),i),i}function _classExtractFieldDescriptor(e,t,i){if(!t.has(e))throw new TypeError("attempted to "+i+" private field on non-instance");return t.get(e)}function _classPrivateMethodGet(e,t,i){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return i}function _checkPrivateRedeclaration(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function _classPrivateFieldInitSpec(e,t,i){_checkPrivateRedeclaration(e,t),t.set(e,i)}function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration(e,t),t.add(e)}var o=new WeakMap;class HandlebarsApplication extends e{constructor(e){super(e),_classPrivateFieldInitSpec(this,o,{writable:!0,value:void 0}),this.popOut&&(this.options.svelte=foundry.utils.mergeObject("object"==typeof this.options.svelte?this.options.svelte:{},{class:t,intro:!0,target:document.body}))}async _render(e,t){_classPrivateFieldSet(this,o,this.options.popOut),this.options.popOut=!1,await super._render(e,t),this.options.popOut=_classPrivateFieldGet(this,o)}_injectHTML(e){var t,i;super._injectHTML(e),null!==(t=this.svelte)&&void 0!==t&&null!==(i=t.applicationShell)&&void 0!==i&&i.elementContent&&this.svelte.applicationShell.elementContent.appendChild(...e)}_replaceHTML(e,t){var i,s;if(e.length)if(super._replaceHTML(e,t),null!==(i=this.svelte)&&void 0!==i&&null!==(s=i.applicationShell)&&void 0!==s&&s.elementContent){const e=this.svelte.applicationShell.elementContent;for(;e.firstChild&&!e.lastChild.remove(););e.appendChild(...t),this.title=this.title}else e.replaceWith(t),this._element=t,this.elementTarget=t[0]}}var c=new WeakMap,p=new WeakMap,h=new WeakMap,d=new WeakMap,u=new WeakMap,v=new WeakMap,f=new WeakMap;class SvelteFormApplication extends FormApplication{constructor(e){super(e),_classPrivateFieldInitSpec(this,c,{writable:!0,value:[null]}),_classPrivateFieldInitSpec(this,p,{writable:!0,value:null}),_classPrivateFieldInitSpec(this,h,{writable:!0,value:null}),_classPrivateFieldInitSpec(this,d,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,u,{writable:!0,value:[]}),_classPrivateFieldInitSpec(this,v,{writable:!0,value:new GetSvelteData(_classPrivateFieldGet(this,c),_classPrivateFieldGet(this,u))}),_classPrivateFieldInitSpec(this,f,{writable:!0,value:void 0}),_classPrivateFieldSet(this,d,new SvelteReactive(this)),_classPrivateFieldSet(this,f,_classPrivateFieldGet(this,d).initialize())}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{draggable:!0,headerButtonNoLabel:!1,jqueryCloseAnimation:!0,zIndex:null})}get elementContent(){return _classPrivateFieldGet(this,h)}get elementTarget(){return _classPrivateFieldGet(this,p)}get reactive(){return _classPrivateFieldGet(this,d)}get svelte(){return _classPrivateFieldGet(this,v)}set elementContent(e){if(!(e instanceof HTMLElement))throw new TypeError("SvelteFormApplication - set elementContent error: 'content' is not an HTMLElement.");_classPrivateFieldSet(this,h,e)}set elementTarget(e){if(!(e instanceof HTMLElement))throw new TypeError("SvelteFormApplication - set elementTarget error: 'target' is not an HTMLElement.");_classPrivateFieldSet(this,p,e)}async close(e={}){const t=Application.RENDER_STATES;if(!e.force&&![t.RENDERED,t.ERROR].includes(this._state))return;_classPrivateFieldGet(this,f).unsubscribe(),this._state=t.CLOSING;const i=$(_classPrivateFieldGet(this,p));if(!i)return this._state=t.CLOSED;for(const e of this.constructor._getInheritanceChain())Hooks.call(`close${e.name}`,this,i);("boolean"!=typeof this.options.jqueryCloseAnimation||this.options.jqueryCloseAnimation)&&(i[0].style.minHeight="0",await new Promise((e=>{i.slideUp(200,(()=>e()))})));const s=[];for(const e of _classPrivateFieldGet(this,u)){s.push(l(e.component));const t=e.config.eventbus;"object"==typeof t&&"function"==typeof t.off&&(t.off(),e.config.eventbus=void 0)}await Promise.all(s),_classPrivateFieldGet(this,u).length=0,i.remove(),_classPrivateFieldGet(this,c)[0]=null,this._element=null,_classPrivateFieldSet(this,h,null),_classPrivateFieldSet(this,p,null),delete ui.windows[this.appId],this._minimized=!1,this._scrollPositions=null,this._state=t.CLOSED,_classPrivateFieldGet(this,f).uiOptionsUpdate((e=>foundry.utils.mergeObject(e,{minimized:this._minimized})))}_injectHTML(e){if(this.popOut&&0===e.length&&Array.isArray(this.options.svelte))throw new Error("SvelteFormApplication - _injectHTML - A popout app with no template can only support one Svelte component.");if(this.updateHeaderButtons(),Array.isArray(this.options.svelte))for(const t of this.options.svelte){const i=s_LOAD_CONFIG(this,e,t);if(n(i.component)){if(null!==this.svelte.applicationShell)throw new Error(`SvelteFormApplication - _injectHTML - An application shell is already mounted; offending config: \n                    ${JSON.stringify(t)}`);_classPrivateFieldGet(this,c)[0]=i.component}_classPrivateFieldGet(this,u).push(i)}else if("object"==typeof this.options.svelte){const t=s_LOAD_CONFIG(this,e,this.options.svelte);if(n(t.component)){if(null!==this.svelte.applicationShell)throw new Error(`SvelteFormApplication - _injectHTML - An application shell is already mounted; offending config: \n                 ${JSON.stringify(this.options.svelte)}`);_classPrivateFieldGet(this,c)[0]=t.component}_classPrivateFieldGet(this,u).push(t)}const t=e.length&&e[0]instanceof DocumentFragment;let i=!0;for(const e of _classPrivateFieldGet(this,u))if(!e.injectHTML){i=!1;break}if(i&&super._injectHTML(e),null!==this.svelte.applicationShell)this._element=$(this.svelte.applicationShell.elementRoot),_classPrivateFieldSet(this,h,a(this.svelte.applicationShell,"elementContent")?this.svelte.applicationShell.elementContent:null),_classPrivateFieldSet(this,p,a(this.svelte.applicationShell,"elementTarget")?this.svelte.applicationShell.elementTarget:null);else if(t)for(const e of _classPrivateFieldGet(this,u))if(e.element instanceof HTMLElement){this._element=$(e.element);break}if(null===_classPrivateFieldGet(this,p)){const e="string"==typeof this.options.selectorTarget?this._element.find(this.options.selectorTarget):this._element;_classPrivateFieldSet(this,p,e[0])}if(null===_classPrivateFieldGet(this,p)||void 0===_classPrivateFieldGet(this,p)||0===_classPrivateFieldGet(this,p).length)throw new Error(`SvelteFormApplication - _injectHTML: Target element '${this.options.selectorTarget}' not found.`);setTimeout((()=>_classPrivateFieldGet(this,f).subscribe()),0),this.onSvelteMount({element:this._element[0],elementContent:_classPrivateFieldGet(this,h),elementTarget:_classPrivateFieldGet(this,p)})}async maximize(){if(this.popOut&&![!1,null].includes(this._minimized))return _classPrivateFieldGet(this,f).uiOptionsUpdate((e=>foundry.utils.mergeObject(e,{minimized:!1}))),super.maximize()}async minimize(){if(this.rendered&&this.popOut&&![!0,null].includes(this._minimized))return _classPrivateFieldGet(this,f).uiOptionsUpdate((e=>foundry.utils.mergeObject(e,{minimized:!0}))),super.minimize()}onSvelteMount({element:e,elementContent:t,elementTarget:i}){}_replaceHTML(e,t){e.length&&this.updateHeaderButtons()}async _renderInner(e){const t="string"==typeof this.template?await renderTemplate(this.template,e):document.createDocumentFragment();return $(t)}setPosition({left:e,top:t,width:i,height:s,scale:l,noHeight:n=!1,noWidth:a=!1}={}){const r=this.elementTarget,o=this.position,c=globalThis.getComputedStyle(r);if(!r.style.width||i){const t=i||r.offsetWidth,s=parseInt(c.minWidth)||MIN_WINDOW_WIDTH,l=r.style.maxWidth||globalThis.innerWidth;o.width=i=Math.clamped(t,s,l),a||(r.style.width=`${i}px`),i+o.left>globalThis.innerWidth&&(e=o.left)}if(i=r.offsetWidth,!r.style.height||s){const e=s||r.offsetHeight+1,i=parseInt(c.minHeight)||MIN_WINDOW_HEIGHT,l=r.style.maxHeight||globalThis.innerHeight;o.height=s=Math.clamped(e,i,l),n||(r.style.height=`${s}px`),s+o.top>globalThis.innerHeight+1&&(t=o.top-1)}if(s=r.offsetHeight,!r.style.left||Number.isFinite(e)){const t=Number.isFinite(e)?e:(globalThis.innerWidth-i)/2,s=Math.max(globalThis.innerWidth-i,0);o.left=e=Math.clamped(t,0,s),r.style.left=`${e}px`}if(!r.style.top||Number.isFinite(t)){const e=Number.isFinite(t)?t:(globalThis.innerHeight-s)/2,i=Math.max(globalThis.innerHeight-s,0);o.top=t=Math.clamped(e,0,i),r.style.top=`${o.top}px`}return l&&(o.scale=Math.max(l,0),r.style.transform=1===l?"":`scale(${l})`),o}}function s_LOAD_CONFIG(e,t,i){const s="object"==typeof i.options?i.options:{};let l;if(l=i.target instanceof HTMLElement?i.target:"string"==typeof i.target?t.find(i.target).get(0):document.createDocumentFragment(),void 0===l)throw new Error(`SvelteFormApplication - s_LOAD_CONFIG - could not find target selector: ${i.target} for config:\n${JSON.stringify(i)}`);const a=i.class,o=r(_objectSpread2(_objectSpread2({},i),{},{target:l}),e),c=o.context.get("external");let p;c.foundryApp=e,"object"==typeof e._eventbus&&"function"==typeof e._eventbus.createProxy&&(p=e._eventbus.createProxy(),c.eventbus=p);const h=new a(o);let d;if(o.eventbus=p,n(h)&&(d=h.elementRoot),i.target instanceof DocumentFragment&&l.firstElementChild)void 0===d&&(d=l.firstElementChild),t.append(l);else if(i.target instanceof HTMLElement&&void 0===d){if(i.target instanceof HTMLElement&&"string"!=typeof s.selectorElement)throw new Error(`SvelteFormApplication - s_LOAD_CONFIG - HTMLElement target with no 'selectorElement' defined for config:\n${JSON.stringify(i)}`);if(d=l.querySelector(s.selectorElement),null==d)throw new Error(`SvelteFormApplication - s_LOAD_CONFIG - HTMLElement target - could not find 'selectorElement' for config:\n${JSON.stringify(i)}`)}const u={config:o,component:h,element:d,injectHTML:!(i.target instanceof HTMLElement)};return Object.freeze(u),u}var m=new WeakMap,_=new WeakMap;class GetSvelteData{constructor(e,t){_classPrivateFieldInitSpec(this,m,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,_,{writable:!0,value:void 0}),_classPrivateFieldSet(this,m,e),_classPrivateFieldSet(this,_,t),Object.freeze(this)}get applicationShell(){return _classPrivateFieldGet(this,m)[0]}component(e){const t=_classPrivateFieldGet(this,_)[e];return"object"==typeof t?null==t?void 0:t.component:void 0}*componentEntries(){for(let e=0;e<_classPrivateFieldGet(this,_).length;e++)yield[e,_classPrivateFieldGet(this,_)[e].component]}*componentValues(){for(let e=0;e<_classPrivateFieldGet(this,_).length;e++)yield _classPrivateFieldGet(this,_)[e].component}data(e){return _classPrivateFieldGet(this,_)[e]}dataEntries(){return _classPrivateFieldGet(this,_).entries()}dataValues(){return _classPrivateFieldGet(this,_).values()}get length(){return _classPrivateFieldGet(this,_).length}}var b=new WeakMap,g=new WeakMap,F=new WeakMap,P=new WeakMap,y=new WeakMap,w=new WeakMap,S=new WeakMap,O=new WeakSet,G=new WeakSet,M=new WeakSet;class SvelteReactive{constructor(e){_classPrivateMethodInitSpec(this,M),_classPrivateMethodInitSpec(this,G),_classPrivateMethodInitSpec(this,O),_classPrivateFieldInitSpec(this,b,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,g,{writable:!0,value:!1}),_classPrivateFieldInitSpec(this,F,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,P,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,y,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,w,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,S,{writable:!0,value:[]}),_classPrivateFieldSet(this,b,e),Object.freeze(this)}initialize(){if(!_classPrivateFieldGet(this,g))return _classPrivateFieldSet(this,g,!0),_classPrivateMethodGet(this,O,_storesInitialize2).call(this),{appOptionsUpdate:_classPrivateFieldGet(this,P),uiOptionsUpdate:_classPrivateFieldGet(this,w),subscribe:_classPrivateMethodGet(this,G,_storesSubscribe2),unsubscribe:_classPrivateMethodGet(this,M,_storesUnsubscribe2)}}get draggable(){var e,t;return null===(e=_classPrivateFieldGet(this,b))||void 0===e||null===(t=e.options)||void 0===t?void 0:t.draggable}get minimizable(){var e,t;return null===(e=_classPrivateFieldGet(this,b))||void 0===e||null===(t=e.options)||void 0===t?void 0:t.minimizable}get popOut(){return _classPrivateFieldGet(this,b).popOut}get resizable(){var e,t;return null===(e=_classPrivateFieldGet(this,b))||void 0===e||null===(t=e.options)||void 0===t?void 0:t.resizable}get storeAppOptions(){return _classPrivateFieldGet(this,F)}get storeUIOptions(){return _classPrivateFieldGet(this,y)}get title(){return _classPrivateFieldGet(this,b).title}get zIndex(){var e,t;return null===(e=_classPrivateFieldGet(this,b))||void 0===e||null===(t=e.options)||void 0===t?void 0:t.zIndex}set draggable(e){"boolean"==typeof e&&this.setOptions("draggable",e)}set minimizable(e){"boolean"==typeof e&&this.setOptions("minimizable",e)}set popOut(e){"boolean"==typeof e&&this.setOptions("popOut",e)}set resizable(e){"boolean"==typeof e&&this.setOptions("resizable",e)}set title(e){"string"==typeof e&&this.setOptions("title",e)}set zIndex(e){this.setOptions("zIndex",Number.isInteger(e)?e:null)}getOptions(e,t){return function(e,t,i){if("object"!=typeof e)return i;if("string"!=typeof t)return i;const s=t.split(".");for(let t=0;t<s.length;t++){if(void 0===e[s[t]]||null===e[s[t]])return i;e=e[s[t]]}return e}(_classPrivateFieldGet(this,b).options,e,t)}mergeOptions(e){_classPrivateFieldGet(this,P).call(this,(t=>foundry.utils.mergeObject(t,e)))}setOptions(e,t){const i=function(e,t,i,s="set",l=!0){if("object"!=typeof e)throw new TypeError("safeSet Error: 'data' is not an 'object'.");if("string"!=typeof t)throw new TypeError("safeSet Error: 'accessor' is not a 'string'.");const n=t.split(".");for(let t=0;t<n.length;t++){if(Array.isArray(e)){const e=+n[t];if(!Number.isInteger(e)||e<0)return!1}if(t===n.length-1)switch(s){case"add":e[n[t]]+=i;break;case"div":e[n[t]]/=i;break;case"mult":e[n[t]]*=i;break;case"set":e[n[t]]=i;break;case"set-undefined":void 0===e[n[t]]&&(e[n[t]]=i);break;case"sub":e[n[t]]-=i}else{if(l&&void 0===e[n[t]]&&(e[n[t]]={}),null===e[n[t]]||"object"!=typeof e[n[t]])return!1;e=e[n[t]]}}return!0}(_classPrivateFieldGet(this,b).options,e,t);i&&_classPrivateFieldGet(this,P).call(this,(()=>_classPrivateFieldGet(this,b).options))}updateHeaderButtons(){const e=_classPrivateFieldGet(this,b)._getHeaderButtons();if("boolean"==typeof _classPrivateFieldGet(this,b).options.headerButtonNoLabel&&_classPrivateFieldGet(this,b).options.headerButtonNoLabel)for(const t of e)t.label=void 0;_classPrivateFieldGet(this,w).call(this,(t=>(t.headerButtons=e,t)))}}function _storesInitialize2(){const e=i(_classPrivateFieldGet(this,b).options);_classPrivateFieldSet(this,P,e.update);const t={subscribe:e.subscribe,draggable:s(e,((e,t)=>t(e.draggable))),minimizable:s(e,((e,t)=>t(e.minimizable))),popOut:s(e,((e,t)=>t(e.popOut))),resizable:s(e,((e,t)=>t(e.resizable))),title:s(e,((e,t)=>t(e.title))),zIndex:s(e,((e,t)=>t(Number.isInteger(e.zIndex)?e.zIndex:null)))};Object.freeze(t),_classPrivateFieldSet(this,F,t);const l=i({headerButtons:[],minimized:_classPrivateFieldGet(this,b)._minimized});_classPrivateFieldSet(this,w,l.update);const n={subscribe:l.subscribe,headerButtons:s(l,((e,t)=>t(e.headerButtons))),minimized:s(l,((e,t)=>t(e.minimized)))};Object.freeze(n),_classPrivateFieldSet(this,y,n)}function _storesSubscribe2(){_classPrivateFieldGet(this,S).push(_classPrivateFieldGet(this,F).popOut.subscribe((e=>{e&&_classPrivateFieldGet(this,b).rendered?ui.windows[_classPrivateFieldGet(this,b).appId]=_classPrivateFieldGet(this,b):delete ui.windows[_classPrivateFieldGet(this,b).appId]}))),_classPrivateFieldGet(this,S).push(_classPrivateFieldGet(this,F).zIndex.subscribe((e=>{null!==_classPrivateFieldGet(this,b)._element&&(_classPrivateFieldGet(this,b)._element[0].style.zIndex=e)})))}function _storesUnsubscribe2(){_classPrivateFieldGet(this,S).forEach((e=>e())),_classPrivateFieldSet(this,S,[])}var T=new WeakMap;class HandlebarsFormApplication extends SvelteFormApplication{constructor(e,i){super(e,i),_classPrivateFieldInitSpec(this,T,{writable:!0,value:void 0}),this.popOut&&(this.options.svelte=foundry.utils.mergeObject("object"==typeof this.options.svelte?this.options.svelte:{},{class:t,intro:!0,target:document.body}))}async _render(e,t){_classPrivateFieldSet(this,T,this.options.popOut),this.options.popOut=!1,await super._render(e,t),this.options.popOut=_classPrivateFieldGet(this,T)}async _renderInner(e){const t=await super._renderInner(e);return this.form=t.filter(((e,t)=>t instanceof HTMLFormElement))[0],this.form||(this.form=t.find("form")[0]),t}_injectHTML(e){var t,i;super._injectHTML(e),null!==(t=this.svelte)&&void 0!==t&&null!==(i=t.applicationShell)&&void 0!==i&&i.elementContent&&this.svelte.applicationShell.elementContent.appendChild(...e)}_replaceHTML(e,t){var i,s;if(e.length)if(super._replaceHTML(e,t),null!==(i=this.svelte)&&void 0!==i&&null!==(s=i.applicationShell)&&void 0!==s&&s.elementContent){const e=this.svelte.applicationShell.elementContent;for(;e.firstChild&&!e.lastChild.remove(););e.appendChild(...t),this.title=this.title}else e.replaceWith(t),this._element=t,this.elementTarget=t[0]}}export{HandlebarsApplication,HandlebarsFormApplication};
//# sourceMappingURL=legacy.js.map

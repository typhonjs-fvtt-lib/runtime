import{SvelteApplication as e}from"/modules/typhonjs/svelte/application.js";import{ApplicationShell as t}from"/modules/typhonjs/svelte/component/core.js";import{writable as i,derived as n}from"/modules/typhonjs/svelte/store.js";import{outroAndDestroy as s,isApplicationShell as o,hasGetter as r,parseSvelteConfig as l}from"/modules/typhonjs/svelte/util.js";function a(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function h(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?a(Object(i),!0).forEach((function(t){p(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):a(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function p(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function c(e,t){return function(e,t){return t.get?t.get.call(e):t.value}(e,f(e,t,"get"))}function u(e,t,i){return function(e,t,i){if(t.set)t.set.call(e,i);else{if(!t.writable)throw new TypeError("attempted to set read only private field");t.value=i}}(e,f(e,t,"set"),i),i}function f(e,t,i){if(!t.has(e))throw new TypeError("attempted to "+i+" private field on non-instance");return t.get(e)}function m(e,t,i){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return i}function d(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function g(e,t,i){d(e,t),t.set(e,i)}function b(e,t){d(e,t),t.add(e)}var v=new WeakMap;class y extends e{constructor(e){super(e),g(this,v,{writable:!0,value:void 0}),this.popOut&&(this.options.svelte=foundry.utils.mergeObject("object"==typeof this.options.svelte?this.options.svelte:{},{class:t,intro:!0,target:document.body}))}async _render(e,t){u(this,v,this.options.popOut),this.options.popOut=!1,await super._render(e,t),this.options.popOut=c(this,v)}_injectHTML(e){var t,i;super._injectHTML(e),null!==(t=this.svelte)&&void 0!==t&&null!==(i=t.applicationShell)&&void 0!==i&&i.elementContent&&this.svelte.applicationShell.elementContent.appendChild(...e)}_replaceHTML(e,t){var i,n;if(e.length)if(super._replaceHTML(e,t),null!==(i=this.svelte)&&void 0!==i&&null!==(n=i.applicationShell)&&void 0!==n&&n.elementContent){const e=this.svelte.applicationShell.elementContent;for(;e.firstChild&&!e.lastChild.remove(););e.appendChild(...t),this.title=this.title}else e.replaceWith(t),this._element=t,this.elementTarget=t[0]}}var w=new WeakMap,O=new WeakMap;class T{constructor(e,t){g(this,w,{writable:!0,value:void 0}),g(this,O,{writable:!0,value:void 0}),u(this,w,e),u(this,O,t)}get applicationShell(){return c(this,w)[0]}component(e){const t=c(this,O)[e];return"object"==typeof t?null==t?void 0:t.component:void 0}*componentEntries(){for(let e=0;e<c(this,O).length;e++)yield[e,c(this,O)[e].component]}*componentValues(){for(let e=0;e<c(this,O).length;e++)yield c(this,O)[e].component}data(e){return c(this,O)[e]}dataEntries(){return c(this,O).entries()}dataValues(){return c(this,O).values()}get length(){return c(this,O).length}}Object.freeze(T);var j=new WeakMap,_=new WeakMap,M=new WeakMap,E=new WeakMap,H=new WeakMap,S=new WeakMap,z=new WeakMap,L=new WeakMap,C=new WeakMap,W=new WeakMap,I=new WeakMap,x=new WeakSet,A=new WeakSet,k=new WeakSet;class N extends FormApplication{constructor(e,t){super(e,t),b(this,k),b(this,A),b(this,x),g(this,_,{get:D,set:void 0}),g(this,j,{writable:!0,value:[null]}),g(this,M,{writable:!0,value:null}),g(this,E,{writable:!0,value:null}),g(this,H,{writable:!0,value:void 0}),g(this,S,{writable:!0,value:void 0}),g(this,z,{writable:!0,value:void 0}),g(this,L,{writable:!0,value:void 0}),g(this,C,{writable:!0,value:[]}),g(this,W,{writable:!0,value:[]}),g(this,I,{writable:!0,value:new T(c(this,j),c(this,W))}),m(this,x,F).call(this)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{draggable:!0,headerButtonNoLabel:!1,jqueryCloseAnimation:!0,zIndex:null})}get draggable(){return this.options.draggable}get elementContent(){return c(this,E)}get elementTarget(){return c(this,M)}get popOut(){return super.popOut}get resizable(){return this.options.resizable}get svelte(){return c(this,I)}get title(){return super.title}get zIndex(){return this.options.zIndex}set draggable(e){"boolean"==typeof e&&this.setOptions("draggable",e)}set elementContent(e){if(!(e instanceof HTMLElement))throw new TypeError("SvelteFormApplication - set elementContent error: 'content' is not an HTMLElement.");u(this,E,e)}set elementTarget(e){if(!(e instanceof HTMLElement))throw new TypeError("SvelteFormApplication - set elementTarget error: 'target' is not an HTMLElement.");u(this,M,e)}set popOut(e){"boolean"==typeof e&&this.setOptions("popOut",e)}set resizable(e){"boolean"==typeof e&&this.setOptions("resizable",e)}set title(e){"string"==typeof e&&this.setOptions("title",e)}set zIndex(e){this.setOptions("zIndex",Number.isInteger(e)?e:null)}async close(e={}){const t=Application.RENDER_STATES;if(!e.force&&![t.RENDERED,t.ERROR].includes(this._state))return;m(this,k,B).call(this),this._state=t.CLOSING;const i=$(c(this,M));if(!i)return this._state=t.CLOSED;for(const e of this.constructor._getInheritanceChain())Hooks.call(`close${e.name}`,this,i);("boolean"!=typeof this.options.jqueryCloseAnimation||this.options.jqueryCloseAnimation)&&(i[0].style.minHeight="0",await new Promise((e=>{i.slideUp(200,(()=>e()))})));const n=[];for(const e of c(this,W)){n.push(s(e.component));const t=e.config.eventbus;"object"==typeof t&&"function"==typeof t.off&&(t.off(),e.config.eventbus=void 0)}await Promise.all(n),c(this,W).length=0,i.remove(),c(this,j)[0]=null,this._element=null,u(this,E,null),u(this,M,null),delete ui.windows[this.appId],this._minimized=!1,this._scrollPositions=null,this._state=t.CLOSED,c(this,L).call(this,(e=>foundry.utils.mergeObject(e,{minimized:this._minimized})))}getOptions(e,t){return function(e,t,i){if("object"!=typeof e)return i;if("string"!=typeof t)return i;const n=t.split(".");for(let t=0;t<n.length;t++){if(void 0===e[n[t]]||null===e[n[t]])return i;e=e[n[t]]}return e}(this.options,e,t)}_injectHTML(e){if(this.popOut&&0===e.length&&Array.isArray(this.options.svelte))throw new Error("SvelteApplication - _injectHTML - A popout app with no template can only support one Svelte component.");if(this.updateHeaderButtons(),Array.isArray(this.options.svelte))for(const t of this.options.svelte){const i=R(this,e,t,c(this,H),c(this,z));if(o(i.component)){if(null!==c(this,_))throw new Error(`SvelteApplication - _injectHTML - An application shell is already mounted; offending config: \n                    ${JSON.stringify(t)}`);c(this,j)[0]=i.component}c(this,W).push(i)}else if("object"==typeof this.options.svelte){const t=R(this,e,this.options.svelte,c(this,H),c(this,z));if(o(t.component)){if(null!==c(this,_))throw new Error(`SvelteApplication - _injectHTML - An application shell is already mounted; offending config: \n                 ${JSON.stringify(this.options.svelte)}`);c(this,j)[0]=t.component}c(this,W).push(t)}const t=e.length&&e[0]instanceof DocumentFragment;let i=!0;for(const e of c(this,W))if(!e.injectHTML){i=!1;break}if(i&&super._injectHTML(e),null!==c(this,_))this._element=$(c(this,_).elementRoot),u(this,E,r(c(this,_),"elementContent")?c(this,_).elementContent:null),u(this,M,r(c(this,_),"elementTarget")?c(this,_).elementTarget:null);else if(t)for(const e of c(this,W))if(e.element instanceof HTMLElement){this._element=$(e.element);break}if(null===c(this,M)){const e="string"==typeof this.options.selectorTarget?this._element.find(this.options.selectorTarget):this._element;u(this,M,e[0])}if(null===c(this,M)||void 0===c(this,M)||0===c(this,M).length)throw new Error(`SvelteApplication - _injectHTML: Target element '${this.options.selectorTarget}' not found.`);setTimeout((()=>m(this,A,P).call(this)),0),this.onSvelteMount({element:this._element[0],elementContent:c(this,E),elementTarget:c(this,M)})}async maximize(){if(this.popOut&&![!1,null].includes(this._minimized))return c(this,L).call(this,(e=>foundry.utils.mergeObject(e,{minimized:!1}))),super.maximize()}async minimize(){if(this.rendered&&this.popOut&&![!0,null].includes(this._minimized))return c(this,L).call(this,(e=>foundry.utils.mergeObject(e,{minimized:!0}))),super.minimize()}mergeOptions(e){c(this,S).call(this,(t=>foundry.utils.mergeObject(t,e)))}onSvelteMount({element:e,elementContent:t,elementTarget:i}){}_replaceHTML(e,t){e.length&&this.updateHeaderButtons()}async _renderInner(e){const t="string"==typeof this.template?await renderTemplate(this.template,e):document.createDocumentFragment();return $(t)}setOptions(e,t){const i=function(e,t,i,n="set",s=!0){if("object"!=typeof e)throw new TypeError("safeSet Error: 'data' is not an 'object'.");if("string"!=typeof t)throw new TypeError("safeSet Error: 'accessor' is not a 'string'.");const o=t.split(".");for(let t=0;t<o.length;t++){if(Array.isArray(e)){const e=+o[t];if(!Number.isInteger(e)||e<0)return!1}if(t===o.length-1)switch(n){case"add":e[o[t]]+=i;break;case"div":e[o[t]]/=i;break;case"mult":e[o[t]]*=i;break;case"set":e[o[t]]=i;break;case"set-undefined":void 0===e[o[t]]&&(e[o[t]]=i);break;case"sub":e[o[t]]-=i}else{if(s&&void 0===e[o[t]]&&(e[o[t]]={}),null===e[o[t]]||"object"!=typeof e[o[t]])return!1;e=e[o[t]]}}return!0}(this.options,e,t);i&&c(this,S).call(this,(()=>this.options))}setPosition({left:e,top:t,width:i,height:n,scale:s,noHeight:o=!1,noWidth:r=!1}={}){const l=this.elementTarget,a=this.position,h=globalThis.getComputedStyle(l);if(!l.style.width||i){const t=i||l.offsetWidth,n=parseInt(h.minWidth)||MIN_WINDOW_WIDTH,s=l.style.maxWidth||globalThis.innerWidth;a.width=i=Math.clamped(t,n,s),r||(l.style.width=`${i}px`),i+a.left>globalThis.innerWidth&&(e=a.left)}if(i=l.offsetWidth,!l.style.height||n){const e=n||l.offsetHeight+1,i=parseInt(h.minHeight)||MIN_WINDOW_HEIGHT,s=l.style.maxHeight||globalThis.innerHeight;a.height=n=Math.clamped(e,i,s),o||(l.style.height=`${n}px`),n+a.top>globalThis.innerHeight+1&&(t=a.top-1)}if(n=l.offsetHeight,!l.style.left||Number.isFinite(e)){const t=Number.isFinite(e)?e:(globalThis.innerWidth-i)/2,n=Math.max(globalThis.innerWidth-i,0);a.left=e=Math.clamped(t,0,n),l.style.left=`${e}px`}if(!l.style.top||Number.isFinite(t)){const e=Number.isFinite(t)?t:(globalThis.innerHeight-n)/2,i=Math.max(globalThis.innerHeight-n,0);a.top=t=Math.clamped(e,0,i),l.style.top=`${a.top}px`}return s&&(a.scale=Math.max(s,0),l.style.transform=1===s?"":`scale(${s})`),a}updateHeaderButtons(){const e=this._getHeaderButtons();if("boolean"==typeof this.options.headerButtonNoLabel&&this.options.headerButtonNoLabel)for(const t of e)t.label=void 0;c(this,L).call(this,(t=>(t.headerButtons=e,t)))}}function D(){return c(this,j)[0]}function F(){const e=i(this.options);u(this,S,e.update);const t={subscribe:e.subscribe,draggable:n(e,((e,t)=>t(e.draggable))),minimizable:n(e,((e,t)=>t(e.minimizable))),popOut:n(e,((e,t)=>t(e.popOut))),resizable:n(e,((e,t)=>t(e.resizable))),title:n(e,((e,t)=>t(e.title))),zIndex:n(e,((e,t)=>t(Number.isInteger(e.zIndex)?e.zIndex:null)))};Object.freeze(t),u(this,H,t);const s=i({headerButtons:[],minimized:this._minimized});u(this,L,s.update);const o={subscribe:s.subscribe,headerButtons:n(s,((e,t)=>t(e.headerButtons))),minimized:n(s,((e,t)=>t(e.minimized)))};Object.freeze(o),u(this,z,o)}function P(){c(this,C).push(c(this,H).popOut.subscribe((e=>{e&&this.rendered?ui.windows[this.appId]=this:delete ui.windows[this.appId]}))),c(this,C).push(c(this,H).zIndex.subscribe((e=>{null!==this._element&&(this._element[0].style.zIndex=e)})))}function B(){c(this,C).forEach((e=>e())),u(this,C,[])}function R(e,t,i,n,s){const r="object"==typeof i.options?i.options:{};let a;if(a=i.target instanceof HTMLElement?i.target:"string"==typeof i.target?t.find(i.target).get(0):document.createDocumentFragment(),void 0===a)throw new Error(`SvelteApplication - s_LOAD_CONFIG - could not find target selector: ${i.target} for config:\n${JSON.stringify(i)}`);const p=i.class,c=l(h(h({},i),{},{target:a}),e),u=c.context.get("external");let f;u.foundryApp=e,u.storeAppOptions=n,u.storeUIOptions=s,"object"==typeof e._eventbus&&"function"==typeof e._eventbus.createProxy&&(f=e._eventbus.createProxy(),u.eventbus=f);const m=new p(c);let d;if(c.eventbus=f,o(m)&&(d=m.elementRoot),i.target instanceof DocumentFragment&&a.firstElementChild)void 0===d&&(d=a.firstElementChild),t.append(a);else if(i.target instanceof HTMLElement&&void 0===d){if(i.target instanceof HTMLElement&&"string"!=typeof r.selectorElement)throw new Error(`SvelteApplication - s_LOAD_CONFIG - HTMLElement target with no 'selectorElement' defined for config:\n${JSON.stringify(i)}`);if(d=a.querySelector(r.selectorElement),null==d)throw new Error(`SvelteApplication - s_LOAD_CONFIG - HTMLElement target - could not find 'selectorElement' for config:\n${JSON.stringify(i)}`)}const g={config:c,component:m,element:d,injectHTML:!(i.target instanceof HTMLElement)};return Object.freeze(g),g}var G=new WeakMap;class J extends N{constructor(e,i){super(e,i),g(this,G,{writable:!0,value:void 0}),this.popOut&&(this.options.svelte=foundry.utils.mergeObject("object"==typeof this.options.svelte?this.options.svelte:{},{class:t,intro:!0,target:document.body}))}async _render(e,t){u(this,G,this.options.popOut),this.options.popOut=!1,await super._render(e,t),this.options.popOut=c(this,G)}async _renderInner(e){const t=await super._renderInner(e);return this.form=t.filter(((e,t)=>t instanceof HTMLFormElement))[0],this.form||(this.form=t.find("form")[0]),t}_injectHTML(e){var t,i;super._injectHTML(e),null!==(t=this.svelte)&&void 0!==t&&null!==(i=t.applicationShell)&&void 0!==i&&i.elementContent&&this.svelte.applicationShell.elementContent.appendChild(...e)}_replaceHTML(e,t){var i,n;if(e.length)if(super._replaceHTML(e,t),null!==(i=this.svelte)&&void 0!==i&&null!==(n=i.applicationShell)&&void 0!==n&&n.elementContent){const e=this.svelte.applicationShell.elementContent;for(;e.firstChild&&!e.lastChild.remove(););e.appendChild(...t),this.title=this.title}else e.replaceWith(t),this._element=t,this.elementTarget=t[0]}}export{y as HandlebarsApplication,J as HandlebarsFormApplication};

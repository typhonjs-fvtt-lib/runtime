{"version":3,"file":"typhonjs-oembed.js","sources":["../../src/Settings.js","../../src/core/sanitize.js","../../src/core/Nodes.js","../../src/core/updateHtml.js","../../src/ui/Buttons.js","../../node_modules/@ephox/katamari/lib/main/ts/ephox/katamari/api/Fun.js","../../node_modules/@ephox/katamari/lib/main/ts/ephox/katamari/api/Optional.js","../../node_modules/@ephox/katamari/lib/main/ts/ephox/katamari/api/Obj.js","../../src/core/htmlToData.js","../../src/core/Service.js","../../src/ui/Dialog.js","../../src/Plugin.js","../../src/core/ResolveName.js","../../src/core/FilterContent.js","../../src/core/Selection.js"],"sourcesContent":["/**\r\n * Please see `./LICENSE` for license details.\r\n */\r\nexport default class Settings\r\n{\r\n   static getDisableFilePoster(editor)\r\n   {\r\n      return editor.getParam('oembed_disable_file_poster', false);\r\n   }\r\n\r\n   static getDisableFileSource(editor)\r\n   {\r\n      return editor.getParam('oembed_disable_file_source', false);\r\n   }\r\n\r\n   static getMediaHeight(editor)\r\n   {\r\n      return editor.getParam('oembed_default_height', 288);\r\n   }\r\n\r\n   static getMediaWidth(editor)\r\n   {\r\n      return editor.getParam('oembed_default_width', 512);\r\n   }\r\n\r\n   static getUrlResolver(editor)\r\n   {\r\n      return editor.getParam('oembed_url_resolver');\r\n   }\r\n\r\n   static hasDimensions(editor)\r\n   {\r\n      return editor.getParam('oembed_dimensions', true);\r\n   }\r\n\r\n   static hasLiveEmbeds(editor)\r\n   {\r\n      return editor.getParam('oembed_live_embeds', true);\r\n   }\r\n\r\n   static hasPoster(editor)\r\n   {\r\n      return editor.getParam('oembed_poster', true);\r\n   }\r\n\r\n   static shouldFilterHtml(editor)\r\n   {\r\n      return editor.getParam('oembed_filter_html', true);\r\n   }\r\n}","/**\r\n * Please see `./LICENSE` for license details.\r\n */\r\nimport Settings from '../Settings.js';\r\n\r\n/**\r\n * @param {import('tinymce').Editor}  editor -\r\n *\r\n * @param {string}  html -\r\n *\r\n * @returns {string} -\r\n */\r\nexport const sanitize = (editor, html) =>\r\n{\r\n   if (Settings.shouldFilterHtml(editor) === false)\r\n   {\r\n      return html;\r\n   }\r\n\r\n   const writer = tinymce.html.Writer();\r\n   let blocked;\r\n\r\n   tinymce.html.SaxParser({\r\n      validate: false,\r\n      allow_conditional_comments: false,\r\n\r\n      comment: (text) =>\r\n      {\r\n         if (!blocked)\r\n         {\r\n            writer.comment(text);\r\n         }\r\n      },\r\n\r\n      cdata: (text) =>\r\n      {\r\n         if (!blocked)\r\n         {\r\n            writer.cdata(text);\r\n         }\r\n      },\r\n\r\n      text: (text, raw) =>\r\n      {\r\n         if (!blocked)\r\n         {\r\n            writer.text(text, raw);\r\n         }\r\n      },\r\n\r\n      start: (name, attrs, empty) =>\r\n      {\r\n         blocked = true;\r\n\r\n         if (name === 'script' || name === 'noscript' || name === 'svg')\r\n         {\r\n            return;\r\n         }\r\n\r\n         for (let i = attrs.length - 1; i >= 0; i--)\r\n         {\r\n            const attrName = attrs[i].name;\r\n\r\n            if (attrName.indexOf('on') === 0)\r\n            {\r\n               delete attrs.map[attrName];\r\n               attrs.splice(i, 1);\r\n            }\r\n\r\n            if (attrName === 'style')\r\n            {\r\n               attrs[i].value = editor.dom.serializeStyle(editor.dom.parseStyle(attrs[i].value), name);\r\n            }\r\n         }\r\n\r\n         writer.start(name, attrs, empty);\r\n         blocked = false;\r\n      },\r\n\r\n      end: (name) =>\r\n      {\r\n         if (blocked)\r\n         {\r\n            return;\r\n         }\r\n\r\n         writer.end(name);\r\n      }\r\n   }, tinymce.html.Schema({})).parse(html);\r\n\r\n   return writer.getContent();\r\n};\r\n","/**\r\n * Please see `./LICENSE` for license details.\r\n */\r\nimport Settings      from '../Settings.js';\r\nimport { sanitize }  from './sanitize.js';\r\n\r\n/**\r\n * Defines a transparent image.\r\n *\r\n * @type {string}\r\n */\r\nconst s_TRANSPARENT_SRC = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';\r\n\r\n/**\r\n * Stores the poster image temporarily to potentially assign as a `data-oembed-poster`.\r\n *\r\n * @type {string}\r\n */\r\nlet s_OEMBED_POSTER;\r\n\r\n/**\r\n *\r\n */\r\nexport default class Nodes\r\n{\r\n   /**\r\n    * @param {import('tinymce').Editor}  editor -\r\n    *\r\n    * @returns {(function(import('tinymce').html.Node[]): void)} -\r\n    */\r\n   static placeHolderConverter(editor)\r\n   {\r\n      return (nodes) =>\r\n      {\r\n         let i = nodes.length;\r\n         let node;\r\n\r\n         while (i--)\r\n         {\r\n            node = nodes[i];\r\n\r\n            if (!node.parent || node.parent.attr('data-mce-object')) { continue; }\r\n\r\n            if (isLiveEmbedNode(node) && Settings.hasLiveEmbeds(editor))\r\n            {\r\n               if (!isWithinEmbedWrapper(node)) { node.replace(createPreviewNode(editor, node)); }\r\n            }\r\n            else\r\n            {\r\n               if (!isWithinEmbedWrapper(node)) { node.replace(createPlaceholderNode(editor, node)); }\r\n            }\r\n         }\r\n      };\r\n   }\r\n\r\n   /**\r\n    * @param {string}  poster -\r\n    */\r\n   static setPoster(poster)\r\n   {\r\n      s_OEMBED_POSTER = poster;\r\n   }\r\n}\r\n\r\n/**\r\n * @param {import('tinymce').Editor}  editor -\r\n *\r\n * @param {string}  nodeName -\r\n *\r\n * @param {import('tinymce').html.Node} previewNode -\r\n *\r\n * @param {string}  html -\r\n */\r\nconst appendNodeContent = (editor, nodeName, previewNode, html) =>\r\n{\r\n   const newNode = tinymce.html.DomParser({ forced_root_block: false, validate: false },\r\n    editor.schema).parse(html, { context: nodeName });\r\n\r\n   while (newNode.firstChild) { previewNode.append(newNode.firstChild); }\r\n};\r\n\r\n/**\r\n * @param {import('tinymce').Editor}  editor -\r\n *\r\n * @param {import('tinymce').html.Node} node -\r\n *\r\n * @returns {import('tinymce').html.Node} -\r\n */\r\nconst createPreviewNode = (editor, node) =>\r\n{\r\n   const name = node.name;\r\n\r\n   if (s_OEMBED_POSTER !== void 0) { node.attr('data-oembed-poster', s_OEMBED_POSTER); }\r\n\r\n   const previewWrapper = new tinymce.html.Node('span', 1);\r\n   previewWrapper.attr({\r\n      contentEditable: 'false',\r\n      style: node.attr('style'),\r\n      'data-mce-object': name,\r\n      class: `mce-preview-object mce-object-${name}`\r\n   });\r\n\r\n   retainAttributesAndInnerHtml(editor, node, previewWrapper);\r\n\r\n   const styles = editor.dom.parseStyle(node.attr('style'));\r\n   const previewNode = new tinymce.html.Node(name, 1);\r\n\r\n   setDimensions(node, previewNode, styles);\r\n\r\n   previewNode.attr({\r\n      src: node.attr('src'),\r\n      style: node.attr('style'),\r\n      class: node.attr('class')\r\n   });\r\n\r\n   if (name === 'iframe')\r\n   {\r\n      previewNode.attr({\r\n         allowfullscreen: node.attr('allowfullscreen'),\r\n         frameborder: '0'\r\n      });\r\n   }\r\n   else\r\n   {\r\n      // Exclude autoplay as we don't want video/audio to play by default\r\n      const attrs = ['controls', 'crossorigin', 'currentTime', 'loop', 'muted', 'poster', 'preload'];\r\n\r\n      for (const attrName of attrs) { previewNode.attr(attrName, node.attr(attrName)); }\r\n\r\n      // Recreate the child nodes using the sanitized inner HTML\r\n      const sanitizedHtml = previewWrapper.attr('data-mce-html');\r\n      if (sanitizedHtml !== null && sanitizedHtml !== void 0)\r\n      {\r\n         appendNodeContent(editor, name, previewNode, sanitizedHtml);\r\n      }\r\n   }\r\n\r\n   const shimNode = new tinymce.html.Node('span', 1);\r\n   shimNode.attr('class', 'mce-shim');\r\n\r\n   previewWrapper.append(previewNode);\r\n   previewWrapper.append(shimNode);\r\n\r\n   return previewWrapper;\r\n};\r\n\r\n/**\r\n * @param {import('tinymce').Editor}  editor -\r\n *\r\n * @param {import('tinymce').html.Node} node -\r\n *\r\n * @returns {import('tinymce').html.Node} -\r\n */\r\nconst createPlaceholderNode = (editor, node) =>\r\n{\r\n   const name = node.name;\r\n\r\n   if (s_OEMBED_POSTER !== void 0) { node.attr('data-oembed-poster', s_OEMBED_POSTER); }\r\n\r\n   const placeHolder = new tinymce.html.Node('img', 1);\r\n   placeHolder.shortEnded = true;\r\n\r\n   retainAttributesAndInnerHtml(editor, node, placeHolder);\r\n\r\n   const poster = node.attr('data-oembed-poster');\r\n\r\n   setDimensions(node, placeHolder, {});\r\n   placeHolder.attr({\r\n      style: node.attr('style'),\r\n      src: poster ? poster : s_TRANSPARENT_SRC,\r\n      'data-mce-object': name,\r\n      class: `mce-object mce-object-${name}`\r\n   });\r\n\r\n   return placeHolder;\r\n};\r\n\r\n/**\r\n * @param {import('tinymce').html.Node} node -\r\n *\r\n * @param {Record<string, string>} styles -\r\n *\r\n * @param {string} dimension -\r\n *\r\n * @param {string|null} defaultValue -\r\n *\r\n * @returns {string|null} -\r\n */\r\nconst getDimension = (node, styles, dimension, defaultValue = null) =>\r\n{\r\n   const value = node.attr(dimension);\r\n\r\n   if (value !== null && value !== void 0)\r\n   {\r\n      return value;\r\n   }\r\n   else if (!Object.hasOwnProperty.call(styles, dimension))\r\n   {\r\n      return defaultValue;\r\n   }\r\n   else\r\n   {\r\n      return null;\r\n   }\r\n};\r\n\r\n/**\r\n * @param {import('tinymce').html.Node} node -\r\n *\r\n * @returns {boolean} -\r\n */\r\nconst isLiveEmbedNode = (node) =>\r\n{\r\n   const name = node.name;\r\n   return name === 'iframe' || name === 'video' || name === 'audio';\r\n};\r\n\r\n/**\r\n * @param {import('tinymce').html.Node} node -\r\n *\r\n * @returns {boolean} -\r\n */\r\nconst isPageEmbedWrapper = (node) =>\r\n{\r\n   const nodeClass = node.attr('class');\r\n   return nodeClass && (/\\btiny-pageembed\\b/).test(nodeClass);\r\n};\r\n\r\n/**\r\n * @param {import('tinymce').html.Node} node -\r\n *\r\n * @returns {boolean} -\r\n */\r\nconst isWithinEmbedWrapper = (node) =>\r\n{\r\n   while ((node = node.parent))\r\n   {\r\n      if (isPageEmbedWrapper(node)) { return true; }\r\n   }\r\n\r\n   return false;\r\n};\r\n\r\n/**\r\n * @param {import('tinymce').Editor}  editor -\r\n *\r\n * @param {import('tinymce').html.Node} sourceNode -\r\n *\r\n * @param {import('tinymce').html.Node} targetNode -\r\n */\r\nconst retainAttributesAndInnerHtml = (editor, sourceNode, targetNode) =>\r\n{\r\n   // Prefix all attributes except width, height and style since we will add these to the placeholder.\r\n   const attribs = sourceNode.attributes;\r\n   let ai = attribs.length;\r\n   while (ai--)\r\n   {\r\n      const attrName = attribs[ai].name;\r\n      let attrValue = attribs[ai].value;\r\n\r\n      if (attrName !== 'width' && attrName !== 'height' && attrName !== 'style')\r\n      {\r\n         if (attrName === 'data' || attrName === 'src')\r\n         {\r\n            attrValue = editor.convertURL(attrValue, attrName);\r\n         }\r\n\r\n         targetNode.attr(`data-mce-p-${attrName}`, attrValue);\r\n      }\r\n   }\r\n\r\n   // Place the inner HTML contents inside an escaped attribute.\r\n   // This enables us to copy/paste the fake object.\r\n   const innerHtml = sourceNode.firstChild && sourceNode.firstChild.value;\r\n   if (innerHtml)\r\n   {\r\n      targetNode.attr('data-mce-html', escape(sanitize(editor, innerHtml)));\r\n      targetNode.firstChild = null;\r\n   }\r\n};\r\n\r\n/**\r\n * @param {import('tinymce').html.Node} node -\r\n *\r\n * @param {import('tinymce').html.Node} previewNode -\r\n *\r\n * @param {Record<string, string>} styles -\r\n */\r\nconst setDimensions = (node, previewNode, styles) =>\r\n{\r\n   // Apply dimensions for video elements to maintain legacy behaviour.\r\n   const useDefaults = previewNode.name === 'img' || node.name === 'video';\r\n\r\n   // Determine the defaults.\r\n   const defaultWidth = useDefaults ? '300' : null;\r\n   const fallbackHeight = node.name === 'audio' ? '30' : '150';\r\n   const defaultHeight = useDefaults ? fallbackHeight : null;\r\n\r\n   previewNode.attr({\r\n      width: getDimension(node, styles, 'width', defaultWidth),\r\n      height: getDimension(node, styles, 'height', defaultHeight)\r\n   });\r\n};\r\n","/**\r\n * Please see `./LICENSE` for license details.\r\n */\r\n\r\n/**\r\n * @param {AttrList}            attrs -\r\n *\r\n * @param {Record<string, any>} updatedAttrs -\r\n */\r\nconst setAttributes = (attrs, updatedAttrs) =>\r\n{\r\n   const props = Object.keys(updatedAttrs);\r\n   for (let k = 0, len = props.length; k < len; k++)\r\n   {\r\n      const name = props[k];\r\n      const val = updatedAttrs[name];\r\n\r\n      const value = `${val}`;\r\n\r\n      if (attrs.map[name])\r\n      {\r\n         let i = attrs.length;\r\n         while (i--)\r\n         {\r\n            const attr = attrs[i];\r\n\r\n            if (attr.name === name)\r\n            {\r\n               if (value)\r\n               {\r\n                  attrs.map[name] = value;\r\n                  attr.value = value;\r\n               }\r\n               else\r\n               {\r\n                  delete attrs.map[name];\r\n                  attrs.splice(i, 1);\r\n               }\r\n            }\r\n         }\r\n      }\r\n      else if (value)\r\n      {\r\n         attrs.push({\r\n            name,\r\n            value\r\n         });\r\n\r\n         attrs.map[name] = value;\r\n      }\r\n   }\r\n};\r\n\r\nconst sources = ['source'];\r\n\r\n/**\r\n * @param {string}              html -\r\n *\r\n * @param {Partial<MediaData>}  data -\r\n *\r\n * @param {boolean}             [updateAll] -\r\n *\r\n * @returns {string} -\r\n */\r\nexport const updateHtml = (html, data, updateAll) =>\r\n{\r\n   const writer = tinymce.html.Writer();\r\n   let sourceCount = 0;\r\n   let hasImage;\r\n\r\n   tinymce.html.SaxParser({\r\n      validate: false,\r\n      allow_conditional_comments: true,\r\n\r\n      comment: (text) =>\r\n      {\r\n         writer.comment(text);\r\n      },\r\n\r\n      cdata: (text) =>\r\n      {\r\n         writer.cdata(text);\r\n      },\r\n\r\n      text: (text, raw) =>\r\n      {\r\n         writer.text(text, raw);\r\n      },\r\n\r\n      start: (name, attrs, empty) =>\r\n      {\r\n         switch (name)\r\n         {\r\n            case 'video':\r\n            case 'object':\r\n            case 'embed':\r\n            case 'img':\r\n            case 'iframe':\r\n               if (data.height !== undefined && data.width !== undefined)\r\n               {\r\n                  setAttributes(attrs, {\r\n                     width: data.width,\r\n                     height: data.height\r\n                  });\r\n               }\r\n               break;\r\n         }\r\n\r\n         if (updateAll)\r\n         {\r\n            switch (name)\r\n            {\r\n               case 'video':\r\n                  setAttributes(attrs, {\r\n                     poster: data.poster,\r\n                     src: ''\r\n                  });\r\n                  break;\r\n\r\n               case 'iframe':\r\n                  setAttributes(attrs, {\r\n                     src: data.source\r\n                  });\r\n                  break;\r\n\r\n               case 'source':\r\n                  if (sourceCount < 2)\r\n                  {\r\n                     setAttributes(attrs, {\r\n                        src: data[sources[sourceCount]],\r\n                        type: data[`${sources[sourceCount]}mime`]\r\n                     });\r\n\r\n                     if (!data[sources[sourceCount]])\r\n                     {\r\n                        return;\r\n                     }\r\n                  }\r\n                  sourceCount++;\r\n                  break;\r\n\r\n               case 'img':\r\n                  if (!data.poster)\r\n                  {\r\n                     return;\r\n                  }\r\n\r\n                  hasImage = true;\r\n                  break;\r\n            }\r\n         }\r\n\r\n         writer.start(name, attrs, empty);\r\n      },\r\n\r\n      end: (name) =>\r\n      {\r\n         if (name === 'video' && updateAll)\r\n         {\r\n            for (let index = 0; index < 2; index++)\r\n            {\r\n               if (data[sources[index]])\r\n               {\r\n\r\n                  /**\r\n                   * An attribute list.\r\n                   *\r\n                   * @type {any}\r\n                   */\r\n                  const attrs = [];\r\n                  attrs.map = {};\r\n\r\n                  if (sourceCount <= index)\r\n                  {\r\n                     setAttributes(attrs, {\r\n                        src: data[sources[index]],\r\n                        type: data[`${sources[index]}mime`]\r\n                     });\r\n\r\n                     writer.start('source', attrs, true);\r\n                  }\r\n               }\r\n            }\r\n         }\r\n\r\n         if (data.poster && name === 'object' && updateAll && !hasImage)\r\n         {\r\n\r\n            /**\r\n             * An attribute list.\r\n             *\r\n             * @type {any}\r\n             */\r\n            const imgAttrs = [];\r\n            imgAttrs.map = {};\r\n\r\n            setAttributes(imgAttrs, {\r\n               src: data.poster,\r\n               width: data.width,\r\n               height: data.height\r\n            });\r\n\r\n            writer.start('img', imgAttrs, true);\r\n         }\r\n\r\n         writer.end(name);\r\n      }\r\n   }, tinymce.html.Schema({})).parse(html);\r\n\r\n   return writer.getContent();\r\n};\r\n","/**\r\n * Please see `./LICENSE` for license details.\r\n */\r\n\r\n/**\r\n *\r\n */\r\nexport default class Buttons\r\n{\r\n   /**\r\n    * @param {import('tinymce').Editor}  editor -\r\n    */\r\n   static register(editor)\r\n   {\r\n      editor.ui.registry.addToggleButton('typhonjs-oembed', {\r\n         tooltip: 'Insert/edit media',\r\n         icon: 'embed',\r\n         onAction: () =>\r\n         {\r\n            editor.execCommand('typhonjsOembed');\r\n         },\r\n         onSetup: stateSelectorAdapter(editor, ['img[data-mce-object]', 'span[data-mce-object]'])\r\n      });\r\n\r\n      editor.ui.registry.addMenuItem('typhonjs-oembed', {\r\n         icon: 'embed',\r\n         text: 'Media...',\r\n         onAction: () =>\r\n         {\r\n            editor.execCommand('typhonjsOembed');\r\n         }\r\n      });\r\n   }\r\n}\r\n\r\n/**\r\n * @param {import('tinymce').Editor}    editor -\r\n *\r\n * @param {string[]}  selector -\r\n *\r\n * @returns {function(import('tinymce').Toolbar.ToolbarToggleButtonInstanceApi): *} -\r\n */\r\nconst stateSelectorAdapter = (editor, selector) => (buttonApi) =>\r\n editor.selection.selectorChangedWithUnbind(selector.join(','), buttonApi.setActive).unbind;\r\n","import * as Type from './Type';\nvar noop = function () { };\nvar noarg = function (f) { return function () { return f(); }; };\n/** Compose a unary function with an n-ary function */\nvar compose = function (fa, fb) {\n    return function () {\n        var args = [];\n        for (var _i = 0; _i < arguments.length; _i++) {\n            args[_i] = arguments[_i];\n        }\n        return fa(fb.apply(null, args));\n    };\n};\n/** Compose two unary functions. Similar to compose, but avoids using Function.prototype.apply. */\nvar compose1 = function (fbc, fab) { return function (a) {\n    return fbc(fab(a));\n}; };\nvar constant = function (value) {\n    return function () {\n        return value;\n    };\n};\nvar identity = function (x) {\n    return x;\n};\nvar tripleEquals = function (a, b) {\n    return a === b;\n};\n// eslint-disable-next-line prefer-arrow/prefer-arrow-functions\nfunction curry(fn) {\n    var initialArgs = [];\n    for (var _i = 1; _i < arguments.length; _i++) {\n        initialArgs[_i - 1] = arguments[_i];\n    }\n    return function () {\n        var restArgs = [];\n        for (var _i = 0; _i < arguments.length; _i++) {\n            restArgs[_i] = arguments[_i];\n        }\n        var all = initialArgs.concat(restArgs);\n        return fn.apply(null, all);\n    };\n}\nvar not = function (f) { return function (t) {\n    return !f(t);\n}; };\nvar die = function (msg) {\n    return function () {\n        throw new Error(msg);\n    };\n};\nvar apply = function (f) {\n    return f();\n};\nvar call = function (f) {\n    f();\n};\nvar never = constant(false);\nvar always = constant(true);\n/* Used to weaken types */\nvar weaken = function (b) { return b; };\nvar pipe = function (a, ab, bc, cd, de, ef, fg, gh) {\n    var b = ab(a);\n    if (Type.isNullable(bc)) {\n        return b;\n    }\n    var c = bc(b);\n    if (Type.isNullable(cd)) {\n        return c;\n    }\n    var d = cd(c);\n    if (Type.isNullable(de)) {\n        return d;\n    }\n    var e = de(d);\n    if (Type.isNullable(ef)) {\n        return e;\n    }\n    var f = ef(e);\n    if (Type.isNullable(fg)) {\n        return f;\n    }\n    var g = fg(f);\n    if (Type.isNullable(gh)) {\n        return g;\n    }\n    return gh(g);\n};\nexport { noop, noarg, compose, compose1, constant, identity, tripleEquals, curry, not, die, apply, call, never, always, weaken, pipe };\n//# sourceMappingURL=Fun.js.map","import * as Fun from './Fun';\nvar none = function () { return NONE; };\nvar NONE = (function () {\n    var eq = function (o) {\n        return o.isNone();\n    };\n    // inlined from peanut, maybe a micro-optimisation?\n    var call = function (thunk) { return thunk(); };\n    var id = function (n) { return n; };\n    var me = {\n        fold: function (n, _s) { return n(); },\n        is: Fun.never,\n        isSome: Fun.never,\n        isNone: Fun.always,\n        getOr: id,\n        getOrThunk: call,\n        getOrDie: function (msg) {\n            throw new Error(msg || 'error: getOrDie called on none.');\n        },\n        getOrNull: Fun.constant(null),\n        getOrUndefined: Fun.constant(undefined),\n        or: id,\n        orThunk: call,\n        map: none,\n        each: Fun.noop,\n        bind: none,\n        exists: Fun.never,\n        forall: Fun.always,\n        filter: none,\n        equals: eq,\n        equals_: eq,\n        toArray: function () { return []; },\n        toString: Fun.constant('none()')\n    };\n    return me;\n})();\nvar some = function (a) {\n    var constant_a = Fun.constant(a);\n    var self = function () {\n        // can't Fun.constant this one\n        return me;\n    };\n    var bind = function (f) {\n        return f(a);\n    };\n    var me = {\n        fold: function (n, s) { return s(a); },\n        is: function (v) { return a === v; },\n        isSome: Fun.always,\n        isNone: Fun.never,\n        getOr: constant_a,\n        getOrThunk: constant_a,\n        getOrDie: constant_a,\n        getOrNull: constant_a,\n        getOrUndefined: constant_a,\n        or: self,\n        orThunk: self,\n        map: function (f) { return some(f(a)); },\n        each: function (f) {\n            f(a);\n        },\n        bind: bind,\n        exists: bind,\n        forall: bind,\n        filter: function (f) {\n            return f(a) ? me : NONE;\n        },\n        toArray: function () { return [a]; },\n        toString: function () { return 'some(' + a + ')'; },\n        equals: function (o) {\n            return o.is(a);\n        },\n        equals_: function (o, elementEq) {\n            return o.fold(Fun.never, function (b) { return elementEq(a, b); });\n        }\n    };\n    return me;\n};\nvar from = function (value) { return value === null || value === undefined ? NONE : some(value); };\nexport var Optional = {\n    some: some,\n    none: none,\n    from: from\n};\n//# sourceMappingURL=Optional.js.map","import { Eq } from '@ephox/dispute';\nimport * as Fun from './Fun';\nimport { Optional } from './Optional';\n// There are many variations of Object iteration that are faster than the 'for-in' style:\n// http://jsperf.com/object-keys-iteration/107\n//\n// Use the native keys if it is available (IE9+), otherwise fall back to manually filtering\nexport var keys = Object.keys;\n// eslint-disable-next-line @typescript-eslint/unbound-method\nexport var hasOwnProperty = Object.hasOwnProperty;\nexport var each = function (obj, f) {\n    var props = keys(obj);\n    for (var k = 0, len = props.length; k < len; k++) {\n        var i = props[k];\n        var x = obj[i];\n        f(x, i);\n    }\n};\nexport var map = function (obj, f) {\n    return tupleMap(obj, function (x, i) { return ({\n        k: i,\n        v: f(x, i)\n    }); });\n};\nexport var tupleMap = function (obj, f) {\n    var r = {};\n    each(obj, function (x, i) {\n        var tuple = f(x, i);\n        r[tuple.k] = tuple.v;\n    });\n    return r;\n};\nvar objAcc = function (r) { return function (x, i) {\n    r[i] = x;\n}; };\nvar internalFilter = function (obj, pred, onTrue, onFalse) {\n    var r = {};\n    each(obj, function (x, i) {\n        (pred(x, i) ? onTrue : onFalse)(x, i);\n    });\n    return r;\n};\nexport var bifilter = function (obj, pred) {\n    var t = {};\n    var f = {};\n    internalFilter(obj, pred, objAcc(t), objAcc(f));\n    return { t: t, f: f };\n};\nexport var filter = function (obj, pred) {\n    var t = {};\n    internalFilter(obj, pred, objAcc(t), Fun.noop);\n    return t;\n};\nexport var mapToArray = function (obj, f) {\n    var r = [];\n    each(obj, function (value, name) {\n        r.push(f(value, name));\n    });\n    return r;\n};\nexport var find = function (obj, pred) {\n    var props = keys(obj);\n    for (var k = 0, len = props.length; k < len; k++) {\n        var i = props[k];\n        var x = obj[i];\n        if (pred(x, i, obj)) {\n            return Optional.some(x);\n        }\n    }\n    return Optional.none();\n};\nexport var values = function (obj) {\n    return mapToArray(obj, function (v) {\n        return v;\n    });\n};\nexport var size = function (obj) {\n    return keys(obj).length;\n};\nexport var get = function (obj, key) {\n    return has(obj, key) ? Optional.from(obj[key]) : Optional.none();\n};\nexport var has = function (obj, key) {\n    return hasOwnProperty.call(obj, key);\n};\nexport var hasNonNullableKey = function (obj, key) {\n    return has(obj, key) && obj[key] !== undefined && obj[key] !== null;\n};\nexport var isEmpty = function (r) {\n    for (var x in r) {\n        if (hasOwnProperty.call(r, x)) {\n            return false;\n        }\n    }\n    return true;\n};\nexport var equal = function (a1, a2, eq) {\n    if (eq === void 0) { eq = Eq.eqAny; }\n    return Eq.eqRecord(eq).eq(a1, a2);\n};\n//# sourceMappingURL=Obj.js.map","/**\r\n * Please see `./LICENSE` for license details.\r\n */\r\n\r\n/**\r\n * @param {string}   html -\r\n *\r\n * @returns {MediaData} -\r\n */\r\nexport const htmlToData = (html) =>\r\n{\r\n   let data = {};\r\n\r\n   tinymce.html.SaxParser({\r\n      validate: false,\r\n      allow_conditional_comments: true,\r\n      start: (name, attrs) =>\r\n      {\r\n         if (!data.source && name === 'param')\r\n         {\r\n            data.source = attrs.map.movie;\r\n         }\r\n\r\n         if (name === 'iframe' || name === 'object' || name === 'embed' || name === 'video' || name === 'audio')\r\n         {\r\n            if (!data.type)\r\n            {\r\n               data.type = name;\r\n            }\r\n\r\n            data = Object.assign({}, attrs.map, data);\r\n         }\r\n\r\n         if (name === 'source')\r\n         {\r\n            if (!data.source)\r\n            {\r\n               data.source = attrs.map.src;\r\n            }\r\n         }\r\n\r\n         if (name === 'img' && !data.poster)\r\n         {\r\n            data.poster = attrs.map.src;\r\n         }\r\n\r\n         if (attrs.map['data-oembed-poster'] !== void 0)\r\n         {\r\n            data.poster = attrs.map['data-oembed-poster'];\r\n         }\r\n      }\r\n   }).parse(html);\r\n\r\n   data.source = data.source || data.src || data.data;\r\n   data.poster = data.poster || '';\r\n\r\n   return data;\r\n};","/**\r\n * Please see `./LICENSE` for license details.\r\n */\r\nimport Settings from '../Settings.js';\r\n\r\n/**\r\n * @type {Map<string, EmbedData>}\r\n */\r\nconst s_CACHE = new Map();\r\n\r\n/**\r\n * Currently supports Vimeo / YouTube.\r\n *\r\n * @type {OEmbedService[]}\r\n */\r\nconst s_SERVICES = [\r\n   {\r\n      name: 'Vimeo',\r\n      regex: /^(https:\\/\\/vimeo.com\\/(.*)|https:\\/\\/vimeo.com\\/album\\/(.*)\\/video\\/(.*)|https:\\/\\/vimeo.com\\/channels\\/(.*)\\/(.*)|https:\\/\\/vimeo.com\\/groups\\/(.*)\\/videos\\/(.*)|https:\\/\\/vimeo.com\\/ondemand\\/(.*)\\/(.*)|https:\\/\\/player.vimeo.com\\/video\\/(.*))/,\r\n      url: (url, maxwidth, maxheight) => `https://vimeo.com/api/oembed.json?url=${url}&maxwidth=${maxwidth}&maxheight=${maxheight}`\r\n   },\r\n   {\r\n      name: 'YouTube',\r\n      regex: /^(https:\\/\\/(.*).youtube.com\\/watch(.*)|https:\\/\\/(.*).youtube.com\\/v\\/(.*)|https:\\/\\/youtu.be\\/(.*)|https:\\/\\/(.*).youtube.com\\/playlist?list=(.*))/,\r\n      url: (url, maxwidth, maxheight) => `https://www.youtube.com/oembed?url=${url}&format=json&maxwidth=${maxwidth}&maxheight=${maxheight}`\r\n   }\r\n];\r\n\r\n/**\r\n *\r\n */\r\nexport default class Service\r\n{\r\n   /**\r\n    * @param {import('tinymce').Editor}    editor -\r\n    *\r\n    * @param {MediaData} data -\r\n    *\r\n    * @returns {Promise<EmbedData>} -\r\n    */\r\n   static async getEmbedHtml(editor, data)\r\n   {\r\n      let response;\r\n\r\n      if (s_CACHE.has(data.source))\r\n      {\r\n         return s_CACHE.get(data.source);\r\n      }\r\n\r\n      const embedHandler = Settings.getUrlResolver(editor);\r\n\r\n      if (embedHandler)\r\n      {\r\n         try\r\n         {\r\n            const handlerResponse = await embedHandler({ url: data.source });\r\n            response = { url: data.source, html: handlerResponse.html, poster: handlerResponse.poster };\r\n         }\r\n         catch (err)\r\n         {\r\n            const message = err.msg || err.message || 'Unknown error.';\r\n            editor.notificationManager.open({ type: 'error', text: `Media embed error: ${message}` });\r\n\r\n            return void 0;\r\n         }\r\n      }\r\n      else\r\n      {\r\n         let oembedName;\r\n         let oembedUrl;\r\n\r\n         const maxwidth = Settings.getMediaWidth(editor);\r\n         const maxheight = Settings.getMediaHeight(editor);\r\n\r\n         for (const service of s_SERVICES)\r\n         {\r\n            if (service.regex.exec(data.source))\r\n            {\r\n               oembedUrl = service.url(data.source, maxwidth, maxheight);\r\n               oembedName = service.name;\r\n            }\r\n         }\r\n\r\n         if (oembedUrl === void 0)\r\n         {\r\n            editor.notificationManager.open({\r\n               type: 'error',\r\n               text: 'Media embed error: URL did not match any providers available.'\r\n            });\r\n            return void 0;\r\n         }\r\n\r\n         // Fetch the embed URL from YouTube.\r\n         const remoteResponse = await window.fetch(oembedUrl);\r\n\r\n         if (!remoteResponse || remoteResponse.status !== 200)\r\n         {\r\n            editor.notificationManager.open({\r\n               type: 'error',\r\n               text: `Media embed error: Could not fetch ${oembedName} embed URL.`\r\n            });\r\n            return void 0;\r\n         }\r\n\r\n         const json = await remoteResponse.json();\r\n\r\n         if (json.html === void 0)\r\n         {\r\n            const message = json.error ? json.error : `Could not fetch ${oembedName} embed URL.`;\r\n\r\n            editor.notificationManager.open({\r\n               type: 'error',\r\n               text: `Media embed error: ${message}`\r\n            });\r\n            return void 0;\r\n         }\r\n\r\n         response = { url: data.source, html: json.html, poster: json.thumbnail_url };\r\n      }\r\n\r\n      s_CACHE.set(data.source, response);\r\n\r\n      return response;\r\n   }\r\n\r\n   /**\r\n    * @param {string} url -\r\n    *\r\n    * @returns {boolean} URL is cached.\r\n    */\r\n   static isCached(url)\r\n   {\r\n      return s_CACHE.has(url);\r\n   }\r\n}\r\n","/**\r\n * Please see `./LICENSE` for license details.\r\n */\r\nimport { Obj, Optional }   from '@ephox/katamari';\r\n\r\nimport { htmlToData }      from '../core/htmlToData.js';\r\nimport Nodes               from '../core/Nodes.js';\r\nimport Service             from '../core/Service.js';\r\nimport { updateHtml }      from '../core/updateHtml.js';\r\nimport Settings            from '../Settings.js';\r\n\r\n/**\r\n *\r\n */\r\nexport default class Dialog\r\n{\r\n   /**\r\n    * @param {import('tinymce').Editor}  editor -\r\n    */\r\n   static showDialog(editor)\r\n   {\r\n      const editorData = getEditorData(editor);\r\n\r\n      let currentData = editorData;\r\n      const initialData = wrap(editorData);\r\n\r\n      const disableFilePoster = Settings.getDisableFilePoster(editor);\r\n      const disableFileSource = Settings.getDisableFileSource(editor);\r\n\r\n      const items = [];\r\n\r\n      // mediaInput - Dialog.UrlInputSpec\r\n      items.push({\r\n         name: 'source',\r\n         type: 'urlinput',\r\n         filetype: !disableFileSource ? 'media' : void 0,\r\n         label: 'Source'\r\n      });\r\n\r\n      // sizeInput - Dialog.SizeInputSpec\r\n      if (Settings.hasDimensions(editor))\r\n      {\r\n         items.push({\r\n            type: 'sizeinput',\r\n            name: 'dimensions',\r\n            label: 'Constrain proportions',\r\n            constrain: true\r\n         });\r\n      }\r\n\r\n      // mediaPoster - Dialog.UrlInputSpec\r\n      items.push({\r\n         name: 'poster',\r\n         type: 'urlinput',\r\n         filetype: !disableFilePoster ? 'image' : void 0,\r\n         label: 'Media poster (Image URL)'\r\n      });\r\n\r\n      // embedTextarea - Dialog.TextAreaSpec\r\n      items.push({\r\n         name: 'embed',\r\n         type: 'textarea',\r\n         label: 'Generated Embed:',\r\n         disabled: true\r\n      });\r\n\r\n      /**\r\n       * @type {import('tinymce').Dialog.PanelSpec}\r\n       */\r\n      const body = {\r\n         type: 'panel',\r\n         items\r\n      };\r\n\r\n      editor.windowManager.open({\r\n         title: 'Insert/Edit Media (oEmbed)',\r\n         size: 'normal',\r\n\r\n         body,\r\n         buttons: [\r\n            {\r\n               type: 'cancel',\r\n               name: 'cancel',\r\n               text: 'Cancel'\r\n            },\r\n            {\r\n               type: 'submit',\r\n               name: 'save',\r\n               text: 'Save',\r\n               primary: true\r\n            }\r\n         ],\r\n         onSubmit: async (api) =>\r\n         {\r\n            const serviceData = Dialog.unwrap(api.getData());\r\n            await submitForm(currentData, serviceData, editor);\r\n            api.close();\r\n         },\r\n         onChange: async (api, detail) =>\r\n         {\r\n            try\r\n            {\r\n               switch (detail.name)\r\n               {\r\n                  case 'source':\r\n                     await handleSource(currentData, api, editor);\r\n                     break;\r\n\r\n                  case 'embed':\r\n                     handleEmbed(api, editor);\r\n                     break;\r\n\r\n                  case 'dimensions':\r\n                  case 'poster':\r\n                     handleUpdate(api, detail.name);\r\n                     break;\r\n\r\n                  default:\r\n                     break;\r\n               }\r\n               currentData = Dialog.unwrap(api.getData());\r\n            }\r\n            catch (err)\r\n            {\r\n               console.log(err);\r\n            }\r\n         },\r\n         initialData\r\n      }, void 0);\r\n   }\r\n\r\n   /**\r\n    * @param {MediaDialogData}       data -\r\n    *\r\n    * @param {keyof MediaDialogData} [sourceInput] -\r\n    *\r\n    * @returns {MediaData} -\r\n    */\r\n   static unwrap(data, sourceInput)\r\n   {\r\n      const metaData = sourceInput ? extractMeta(sourceInput, data).getOr({}) : {};\r\n      const get = getValue(data, metaData, sourceInput);\r\n      return {\r\n         ...get('source'),\r\n         ...get('poster'),\r\n         ...get('embed'),\r\n         ...getDimensions(data, metaData)\r\n      };\r\n   }\r\n}\r\n\r\n/**\r\n * @type {('width' | 'height')[]}\r\n */\r\nconst s_DIMENSION_ATTR = ['width', 'height'];\r\n\r\n/**\r\n * @param {{ url: string; html: string; poster: string }} response -\r\n *\r\n * @param {import('tinymce').Dialog.DialogInstanceApi<MediaDialogData>}     api -\r\n *\r\n * @param {Editor}  editor -\r\n */\r\nconst addEmbedHtml = (response, api, editor) =>\r\n{\r\n   // Only set values if a URL has been defined\r\n   if (typeof response.url === 'string' && response.url.trim().length > 0)\r\n   {\r\n      const html = response.html;\r\n      const snippetData = snippetToData(editor, html);\r\n\r\n      /**\r\n       * @type {MediaData}\r\n       */\r\n      const nuData = {\r\n         ...snippetData,\r\n         source: response.url,\r\n         embed: html,\r\n         poster: response.poster\r\n      };\r\n\r\n      api.setData(wrap(nuData));\r\n   }\r\n};\r\n\r\n/**\r\n * Note: mainData is DialogSubData\r\n *\r\n * @param {keyof MediaDialogData} sourceInput -\r\n *\r\n * @param {MediaDialogData}       data -\r\n *\r\n * @returns {Optional<Record<string, string>>} -\r\n */\r\nconst extractMeta = (sourceInput, data) => Obj.get(data, sourceInput).bind((mainData) => Obj.get(mainData, 'meta'));\r\n\r\n/**\r\n * @param {MediaDialogData}         data -\r\n *\r\n * @param {Record<string, string>}  metaData -\r\n *\r\n * @returns {{}} -\r\n */\r\nconst getDimensions = (data, metaData) =>\r\n{\r\n   const dimensions = {};\r\n   Obj.get(data, 'dimensions').each((dims) =>\r\n   {\r\n      for (const prop of s_DIMENSION_ATTR)\r\n      {\r\n         Obj.get(metaData, prop).orThunk(() => Obj.get(dims, prop)).each((value) => dimensions[prop] = value);\r\n      }\r\n   });\r\n   return dimensions;\r\n};\r\n\r\n/**\r\n * @param {import('tinymce').Editor} editor -\r\n *\r\n * @returns {MediaData} -\r\n */\r\nconst getEditorData = (editor) =>\r\n{\r\n   const element = editor.selection.getNode();\r\n   const snippet = isMediaElement(element) ? editor.serializer.serialize(element, { selection: true }) : '';\r\n   return {\r\n      embed: snippet,\r\n      ...htmlToData(snippet)\r\n   };\r\n};\r\n\r\n/**\r\n * @param {MediaDialogData}         data -\r\n *\r\n * @param {Record<string, string>}  metaData -\r\n *\r\n * @param {keyof MediaDialogData}   [sourceInput] -\r\n *\r\n * @returns {Function} {function(prop: keyof MediaDialogData): Record<string, string>}\r\n */\r\nconst getValue = (data, metaData, sourceInput) => (prop) =>\r\n{\r\n   // Cases:\r\n   // 1. Get the nested value prop (component is the executed urlinput)\r\n   // 2. Get from metadata (a urlinput was executed but urlinput != this component)\r\n   // 3. Not a urlinput so just get string\r\n   // If prop === sourceInput do 1, 2 then 3, else do 2 then 1 or 3\r\n   // ASSUMPTION: we only want to get values for props that already exist in data\r\n\r\n   /**\r\n    * @returns {Optional<string | Record<string, string> | DialogSubData>} -\r\n    */\r\n   const getFromData = () => Obj.get(data, prop);\r\n\r\n   /**\r\n    * @returns {Optional<string>} -\r\n    */\r\n   const getFromMetaData = () => Obj.get(metaData, prop);\r\n\r\n   /**\r\n    * Note v: string\r\n    *\r\n    * @param {Record<string, string>} c -\r\n    *\r\n    * @returns {Optional<string>} -\r\n    */\r\n   const getNonEmptyValue = (c) => Obj.get(c, 'value').bind((v) => v.length > 0 ? Optional.some(v) : Optional.none());\r\n\r\n   /**\r\n    * @returns {Optional<string>} -\r\n    */\r\n   const getFromValueFirst = () => getFromData().bind((child) => typeof child === 'object' ?\r\n    getNonEmptyValue(child).orThunk(getFromMetaData) : // as Record<string, string>\r\n     getFromMetaData().orThunk(() => Optional.from(child))); // as string\r\n\r\n   /**\r\n    * @returns {Optional<string>} -\r\n    */\r\n   const getFromMetaFirst = () => getFromMetaData().orThunk(() =>\r\n    getFromData().bind((child) => typeof child === 'object' ?\r\n     getNonEmptyValue(child) :   // as Record<string, string>\r\n      Optional.from(child)));    // as string\r\n\r\n   return { [prop]: (prop === sourceInput ? getFromValueFirst() : getFromMetaFirst()).getOr('') };\r\n};\r\n\r\n/**\r\n * @param {MediaData} prevData -\r\n *\r\n * @param {import('tinymce').Dialog.DialogInstanceApi<MediaDialogData>} api -\r\n *\r\n * @param {import('tinymce').Editor} editor -\r\n *\r\n * @returns {Promise<void>} -\r\n */\r\nconst handleSource = async (prevData, api, editor) =>\r\n{\r\n   const serviceData = Dialog.unwrap(api.getData(), 'source');\r\n\r\n   // If a new URL is entered, then clear the embed html and fetch the new data\r\n   if (prevData.source !== serviceData.source)\r\n   {\r\n      addEmbedHtml({ url: serviceData.source, html: '', poster: '' }, api, editor);\r\n\r\n      const response = await Service.getEmbedHtml(editor, serviceData);\r\n      if (response)\r\n      {\r\n         addEmbedHtml(response, api, editor);\r\n      }\r\n   }\r\n};\r\n\r\n/**\r\n * @param {import('tinymce').Dialog.DialogInstanceApi<MediaDialogData>} api -\r\n *\r\n * @param {import('tinymce').Editor} editor -\r\n */\r\nconst handleEmbed = (api, editor) =>\r\n{\r\n   const data = Dialog.unwrap(api.getData());\r\n   const dataFromEmbed = snippetToData(editor, data.embed);\r\n   api.setData(wrap(dataFromEmbed));\r\n};\r\n\r\n/**\r\n * @param {import('tinymce').Dialog.DialogInstanceApi<MediaDialogData>} api -\r\n *\r\n * @param {keyof MediaDialogData} sourceInput -\r\n */\r\nconst handleUpdate = (api, sourceInput) =>\r\n{\r\n   const data = Dialog.unwrap(api.getData(), sourceInput);\r\n   const embed = data.embed ? updateHtml(data.embed, data, false) : '';\r\n   api.setData(wrap({ ...data, embed }));\r\n};\r\n\r\n/**\r\n * @param {import('tinymce').Editor} editor -\r\n *\r\n * @param {string} html -\r\n *\r\n * @param {MediaData} data -\r\n */\r\nconst handleInsert = (editor, html, data) =>\r\n{\r\n   const beforeObjects = editor.dom.select('*[data-mce-object]');\r\n\r\n   Nodes.setPoster(data.poster);\r\n\r\n   editor.insertContent(html);\r\n\r\n   Nodes.setPoster(void 0);\r\n\r\n   const element = selectPlaceholder(editor, beforeObjects);\r\n\r\n   element.dataset.oembedPoster = data.poster;\r\n\r\n   editor.nodeChanged();\r\n};\r\n\r\n/**\r\n * @param {Element} element -\r\n *\r\n * @returns {string} -\r\n */\r\nconst isMediaElement = (element) => element.getAttribute('data-mce-object');\r\n\r\n/**\r\n *\r\n * @param {import('tinymce').Editor} editor -\r\n *\r\n * @param {HTMLElement[]} beforeObjects -\r\n *\r\n * @returns {HTMLElement} -\r\n */\r\nconst selectPlaceholder = (editor, beforeObjects) =>\r\n{\r\n   /**\r\n    * @type {HTMLElement[]}\r\n    */\r\n   const afterObjects = editor.dom.select('*[data-mce-object]');\r\n\r\n   // Find new image placeholder so we can select it\r\n   for (let i = 0; i < beforeObjects.length; i++)\r\n   {\r\n      for (let y = afterObjects.length - 1; y >= 0; y--)\r\n      {\r\n         if (beforeObjects[i] === afterObjects[y])\r\n         {\r\n            afterObjects.splice(y, 1);\r\n         }\r\n      }\r\n   }\r\n\r\n   editor.selection.select(afterObjects[0]);\r\n\r\n   return afterObjects[0];\r\n};\r\n\r\n/**\r\n * @param {import('tinymce').Editor}  editor -\r\n *\r\n * @param {string}  embedSnippet -\r\n *\r\n * @returns {MediaData} -\r\n */\r\nconst snippetToData = (editor, embedSnippet) => htmlToData(embedSnippet);\r\n\r\n/**\r\n * @param {MediaData} prevData -\r\n *\r\n * @param {MediaData} newData -\r\n *\r\n * @param {import('tinymce').Editor}    editor -\r\n *\r\n * @returns {Promise<void>} -\r\n */\r\nconst submitForm = async (prevData, newData, editor) =>\r\n{\r\n   newData.embed = updateHtml(newData.embed, newData);\r\n\r\n   // Only fetch the embed HTML content if the URL has changed from what it previously was\r\n   if (newData.embed && (prevData.source === newData.source || Service.isCached(newData.source)))\r\n   {\r\n      handleInsert(editor, newData.embed, newData);\r\n   }\r\n   else\r\n   {\r\n      const response = await Service.getEmbedHtml(editor, newData);\r\n      if (response)\r\n      {\r\n         handleInsert(editor, response.html, newData);\r\n      }\r\n   }\r\n};\r\n\r\n/**\r\n * @param {MediaData} data -\r\n *\r\n * @returns {MediaDialogData} -\r\n */\r\nconst wrap = (data) =>\r\n{\r\n   /**\r\n    * @type {MediaDialogData}\r\n    */\r\n   const wrapped = {\r\n      ...data,\r\n      source: { value: Obj.get(data, 'source').getOr('') },\r\n      poster: { value: Obj.get(data, 'poster').getOr('') }\r\n   };\r\n\r\n   // Add additional size values that may or may not have been in the html\r\n   for (const prop of s_DIMENSION_ATTR)\r\n   {\r\n      Obj.get(data, prop).each((value) =>\r\n      {\r\n         const dimensions = wrapped.dimensions || {};\r\n         dimensions[prop] = value;\r\n         wrapped.dimensions = dimensions;\r\n      });\r\n   }\r\n\r\n   return wrapped;\r\n};\r\n","/**\r\n * Please see `./LICENSE` for license details.\r\n */\r\nimport FilterContent from './core/FilterContent.js';\r\nimport ResolveName   from './core/ResolveName.js';\r\nimport Selection     from './core/Selection.js';\r\nimport Buttons       from './ui/Buttons.js';\r\nimport Dialog        from './ui/Dialog.js';\r\n\r\nexport class PluginOembed\r\n{\r\n   constructor(editor)\r\n   {\r\n      editor.addCommand('typhonjsOembed', () => Dialog.showDialog(editor));\r\n      Buttons.register(editor);\r\n      ResolveName.setup(editor);\r\n      FilterContent.setup(editor);\r\n      Selection.setup(editor);\r\n   }\r\n\r\n   getMetadata()\r\n   {\r\n      return {\r\n         name: 'TyphonJS oEmbed',\r\n         url: 'https://github.com/typhonjs-tinymce/oembed'\r\n      };\r\n   }\r\n}\r\n\r\nexport default () =>\r\n{\r\n   tinymce.PluginManager.add('typhonjs-oembed', PluginOembed);\r\n};\r\n","/**\r\n * Please see `./LICENSE` for license details.\r\n */\r\n\r\n/**\r\n *\r\n */\r\nexport default class ResolveName\r\n{\r\n   /**\r\n    * @param {import('tinymce').Editor}  editor -\r\n    */\r\n   static setup(editor)\r\n   {\r\n      editor.on('ResolveName', (e) =>\r\n      {\r\n         let name;\r\n\r\n         if (e.target.nodeType === 1 && (name = e.target.getAttribute('data-mce-object')))\r\n         {\r\n            e.name = name;\r\n         }\r\n      });\r\n   }\r\n}\r\n","/**\r\n * Please see `./LICENSE` for license details.\r\n */\r\nimport Nodes         from './Nodes.js';\r\nimport { sanitize }  from './sanitize.js';\r\n\r\n/**\r\n *\r\n */\r\nexport default class FilterContent\r\n{\r\n   /**\r\n    * @param {import('tinymce').Editor}  editor -\r\n    */\r\n   static setup(editor)\r\n   {\r\n      editor.on('preInit', () =>\r\n      {\r\n         // Converts iframe, video etc into placeholder images\r\n         editor.parser.addNodeFilter('iframe,video,audio,object,embed', Nodes.placeHolderConverter(editor));\r\n\r\n         // Replaces placeholder images with real elements for video, object, iframe etc\r\n         editor.serializer.addAttributeFilter('data-mce-object', (nodes, name) =>\r\n         {\r\n            let i = nodes.length;\r\n            let node;\r\n            let realElm;\r\n            let ai;\r\n            let attribs;\r\n            let innerHtml;\r\n            let innerNode;\r\n            let realElmName;\r\n            let className;\r\n\r\n            while (i--)\r\n            {\r\n               node = nodes[i];\r\n               if (!node.parent) { continue; }\r\n\r\n               realElmName = node.attr(name);\r\n               realElm = new tinymce.html.Node(realElmName, 1);\r\n\r\n               // Add width/height to everything but audio\r\n               // if (realElmName !== 'audio' && realElmName !== 'script') {\r\n               if (realElmName !== 'audio')\r\n               {\r\n                  className = node.attr('class');\r\n                  if (className && className.indexOf('mce-preview-object') !== -1)\r\n                  {\r\n                     realElm.attr({\r\n                        width: node.firstChild.attr('width'),\r\n                        height: node.firstChild.attr('height')\r\n                     });\r\n                  }\r\n                  else\r\n                  {\r\n                     realElm.attr({\r\n                        width: node.attr('width'),\r\n                        height: node.attr('height')\r\n                     });\r\n                  }\r\n               }\r\n\r\n               realElm.attr({\r\n                  style: node.attr('style')\r\n               });\r\n\r\n               // Unprefix all placeholder attributes\r\n               attribs = node.attributes;\r\n               ai = attribs.length;\r\n               while (ai--)\r\n               {\r\n                  const attrName = attribs[ai].name;\r\n\r\n                  if (attrName.indexOf('data-mce-p-') === 0)\r\n                  {\r\n                     realElm.attr(attrName.substr(11), attribs[ai].value);\r\n                  }\r\n               }\r\n\r\n               // Inject innerhtml\r\n               innerHtml = node.attr('data-mce-html');\r\n               if (innerHtml)\r\n               {\r\n                  innerNode = new tinymce.html.Node('#text', 3);\r\n                  innerNode.raw = true;\r\n                  innerNode.value = sanitize(editor, unescape(innerHtml));\r\n                  realElm.append(innerNode);\r\n               }\r\n\r\n               node.replace(realElm);\r\n            }\r\n         });\r\n      });\r\n   }\r\n}\r\n","/**\r\n * Please see `./LICENSE` for license details.\r\n */\r\nimport { updateHtml } from './updateHtml.js';\r\n\r\n/**\r\n *\r\n */\r\nexport default class Selection\r\n{\r\n   /**\r\n    * @param {import('tinymce').Editor}  editor -\r\n    */\r\n   static setup(editor)\r\n   {\r\n      editor.on('click keyup touchend', () =>\r\n      {\r\n         const selectedNode = editor.selection.getNode();\r\n\r\n         if (selectedNode && editor.dom.hasClass(selectedNode, 'mce-preview-object'))\r\n         {\r\n            if (editor.dom.getAttrib(selectedNode, 'data-mce-selected'))\r\n            {\r\n               selectedNode.setAttribute('data-mce-selected', '2');\r\n            }\r\n         }\r\n      });\r\n\r\n      editor.on('ObjectSelected', (e) =>\r\n      {\r\n         const objectType = e.target.getAttribute('data-mce-object');\r\n\r\n         if (objectType === 'script')\r\n         {\r\n            e.preventDefault();\r\n         }\r\n      });\r\n\r\n      editor.on('ObjectResized', (e) =>\r\n      {\r\n         const target = e.target;\r\n         let html;\r\n\r\n         if (target.getAttribute('data-mce-object'))\r\n         {\r\n            html = target.getAttribute('data-mce-html');\r\n            if (html)\r\n            {\r\n               html = unescape(html);\r\n               target.setAttribute('data-mce-html', escape(updateHtml(html, {\r\n                  width: String(e.width),\r\n                  height: String(e.height)\r\n               })));\r\n            }\r\n         }\r\n      });\r\n   }\r\n}\r\n\r\n"],"names":["Settings","getDisableFilePoster","editor","getParam","getDisableFileSource","getMediaHeight","getMediaWidth","getUrlResolver","hasDimensions","hasLiveEmbeds","hasPoster","shouldFilterHtml","sanitize","html","writer","tinymce","Writer","blocked","SaxParser","validate","allow_conditional_comments","comment","text","cdata","raw","start","name","attrs","empty","i","length","attrName","indexOf","map","splice","value","dom","serializeStyle","parseStyle","end","Schema","parse","getContent","s_OEMBED_POSTER","Nodes","placeHolderConverter","nodes","node","parent","attr","isLiveEmbedNode","isWithinEmbedWrapper","replace","createPreviewNode","createPlaceholderNode","setPoster","poster","previewWrapper","Node","contentEditable","style","class","retainAttributesAndInnerHtml","styles","previewNode","setDimensions","src","allowfullscreen","frameborder","sanitizedHtml","nodeName","newNode","DomParser","forced_root_block","schema","context","firstChild","append","appendNodeContent","shimNode","placeHolder","shortEnded","getDimension","dimension","defaultValue","Object","hasOwnProperty","call","isPageEmbedWrapper","nodeClass","test","sourceNode","targetNode","attribs","attributes","ai","attrValue","convertURL","innerHtml","escape","useDefaults","defaultWidth","fallbackHeight","defaultHeight","width","height","setAttributes","updatedAttrs","props","keys","k","len","push","sources","updateHtml","data","updateAll","hasImage","sourceCount","undefined","source","type","index","imgAttrs","stateSelectorAdapter","selector","buttonApi","selection","selectorChangedWithUnbind","join","setActive","unbind","eq","id","constant","never","always","none","NONE","o","isNone","fold","n","_s","is","Fun.never","isSome","Fun.always","getOr","getOrThunk","thunk","getOrDie","msg","Error","getOrNull","Fun.constant","getOrUndefined","or","orThunk","each","bind","exists","forall","filter","equals","equals_","toArray","toString","some","a","constant_a","self","me","f","s","v","elementEq","b","Optional","from","get","obj","key","has","htmlToData","movie","assign","s_CACHE","Map","s_SERVICES","regex","url","maxwidth","maxheight","Service","getEmbedHtml","response","embedHandler","handlerResponse","err","message","notificationManager","open","oembedName","oembedUrl","service","exec","remoteResponse","window","fetch","status","json","error","thumbnail_url","set","isCached","Dialog","showDialog","editorData","getEditorData","currentData","initialData","wrap","disableFilePoster","disableFileSource","items","filetype","label","constrain","disabled","body","windowManager","title","size","buttons","primary","onSubmit","async","api","serviceData","unwrap","getData","submitForm","close","onChange","detail","handleSource","handleEmbed","handleUpdate","console","log","sourceInput","metaData","extractMeta","getValue","getDimensions","s_DIMENSION_ATTR","addEmbedHtml","trim","nuData","snippetToData","embed","setData","Obj.get","mainData","dimensions","dims","prop","element","getNode","snippet","isMediaElement","serializer","serialize","getFromData","getFromMetaData","getNonEmptyValue","c","child","prevData","dataFromEmbed","handleInsert","beforeObjects","select","insertContent","selectPlaceholder","dataset","oembedPoster","nodeChanged","getAttribute","afterObjects","y","embedSnippet","newData","wrapped","PluginManager","add","constructor","addCommand","register","ui","registry","addToggleButton","tooltip","icon","onAction","execCommand","onSetup","addMenuItem","setup","on","e","target","nodeType","parser","addNodeFilter","addAttributeFilter","realElm","innerNode","realElmName","className","substr","unescape","selectedNode","hasClass","getAttrib","setAttribute","preventDefault","String","getMetadata"],"mappings":"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"}